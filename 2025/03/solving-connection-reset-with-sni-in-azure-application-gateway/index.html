<!doctype html><html lang=zh-cn x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>解决Azure Application Gateway私网环境下的连接重置问题：SNI参数的关键作用 | 爱解决</title>
<link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://jiejue.ai/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/><meta name=author content="董昊"><meta name=description content="在将Azure Application Gateway从公网迁移到私网环境时，即使配置看似正确，你可能会突然遇到TLS连接被重置的问题。本文将分享一个看似简单却常被忽略的关键配置：SNI（Server Name Indication）参数设置，以及它如何解决连接重置问题。
"><meta name=keywords content><meta name=generator content="Hugo 0.146.5"><meta property="og:url" content="https://jiejue.ai/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/"><meta property="og:site_name" content="爱解决"><meta property="og:title" content="解决Azure Application Gateway私网环境下的连接重置问题：SNI参数的关键作用"><meta property="og:description" content="在将Azure Application Gateway从公网迁移到私网环境时，即使配置看似正确，你可能会突然遇到TLS连接被重置的问题。本文将分享一个看似简单却常被忽略的关键配置：SNI（Server Name Indication）参数设置，以及它如何解决连接重置问题。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-18T20:59:56+04:00"><meta property="article:modified_time" content="2025-03-18T21:29:35+04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="解决Azure Application Gateway私网环境下的连接重置问题：SNI参数的关键作用"><meta name=twitter:description content="在将Azure Application Gateway从公网迁移到私网环境时，即使配置看似正确，你可能会突然遇到TLS连接被重置的问题。本文将分享一个看似简单却常被忽略的关键配置：SNI（Server Name Indication）参数设置，以及它如何解决连接重置问题。"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=翻转一下！><div class="h-10 rounded-full"><img src=/favicon.ico alt=爱解决></div></div><div><a href=https://jiejue.ai/ class="text-lg font-semibold cursor-pointer">爱解决</a><div class="text-base-content/60 text-sm">用AI为人民服务</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=搜索><ion-icon name=search></ion-icon>搜索</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=搜索><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/posts title=归档><ion-icon class=group-hover:text-primary-content name=archive></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/tags title=所有标签><ion-icon class=group-hover:text-primary-content name=pricetags></ion-icon></a></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="解决Azure Application Gateway私网环境下的连接重置问题：SNI参数的关键作用"><meta itemprop=description content="在将Azure Application Gateway从公网迁移到私网环境时，即使配置看似正确，你可能会突然遇到TLS连接被重置的问题。本文将分享一个看似简单却常被忽略的关键配置：SNI（Server Name Indication）参数设置，以及它如何解决连接重置问题。"><meta itemprop=datePublished content="2025-03-18T20:59:56+04:00"><meta itemprop=dateModified content="2025-03-18T21:29:35+04:00"><meta itemprop=wordCount content="3169"><header><h1 itemprop=headline>解决Azure Application Gateway私网环境下的连接重置问题：SNI参数的关键作用</h1><p class=text-sm><span data-format=luxon>2025-03-18T20:59:56+04:00</span>
| <span>7分钟阅读</span>
| <span>更新于
<span data-format=luxon>2025-03-18T21:29:35+04:00</span></span></p><div class="flex justify-between"><div class="flex items-center"><span>@</span>
<span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>董昊</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%e8%a7%a3%e5%86%b3Azure%20Application%20Gateway%e7%a7%81%e7%bd%91%e7%8e%af%e5%a2%83%e4%b8%8b%e7%9a%84%e8%bf%9e%e6%8e%a5%e9%87%8d%e7%bd%ae%e9%97%ae%e9%a2%98%ef%bc%9aSNI%e5%8f%82%e6%95%b0%e7%9a%84%e5%85%b3%e9%94%ae%e4%bd%9c%e7%94%a8&amp;url=https://jiejue.ai/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://jiejue.ai/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://wa.me/?text=%e8%a7%a3%e5%86%b3Azure%20Application%20Gateway%e7%a7%81%e7%bd%91%e7%8e%af%e5%a2%83%e4%b8%8b%e7%9a%84%e8%bf%9e%e6%8e%a5%e9%87%8d%e7%bd%ae%e9%97%ae%e9%a2%98%ef%bc%9aSNI%e5%8f%82%e6%95%b0%e7%9a%84%e5%85%b3%e9%94%ae%e4%bd%9c%e7%94%a8%20https://jiejue.ai/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/" target=_blank rel="noopener noreferrer" title="Share on WhatsApp"><ion-icon class=group-hover:text-primary-content name=logo-whatsapp></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img class="w-full z-30" src=https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250318210156389.webp alt="解决Azure Application Gateway私网环境下的连接重置问题：SNI参数的关键作用"><p>在将Azure Application Gateway从公网迁移到私网环境时，即使配置看似正确，你可能会突然遇到TLS连接被重置的问题。本文将分享一个看似简单却常被忽略的关键配置：SNI（Server Name Indication）参数设置，以及它如何解决连接重置问题。</p><h2 id=问题场景>问题场景</h2><p>最近，我们需要将一个部署在Azure Application Gateway上的服务从公网IP迁移到私网IP，以满足安全要求。迁移过程看似简单：在Terraform配置中将<code>frontend_ip</code>从<code>appGwPublicIpv4</code>更改为<code>appGwPrivateIpv4</code>。</p><p>然而，当配置应用后，即使正确修改了hosts文件进行DNS解析，尝试访问服务时仍然遇到了以下错误：</p><p class=mathjax>$ curl https://example.jiejue.ai/v1/chat/completions -v --resolve example.jiejue.ai:443:10.23.4.5
* Added example.jiejue.ai:443:10.23.4.5 to DNS cache
* Hostname example.jiejue.ai was found in DNS cache
* Trying 10.23.4.5:443...
* Connected to example.jiejue.ai (10.23.4.5) port 443
* ALPN: curl offers h2,http/1.1
* (304) (OUT), TLS handshake, Client hello (1):
* CAfile: /etc/ssl/cert.pem
* CApath: none
* Recv failure: Connection reset by peer
* LibreSSL/3.3.6: error:02FFF036:system library:func(4095):Connection reset by peer
* Closing connection
curl: (35) Recv failure: Connection reset by peer</p><p>而使用telnet测试基本连接时却是正常的：</p><p class=mathjax>$ telnet 10.23.4.5 443
Trying 10.23.4.5...
Connected to example.jiejue.ai.
Escape character is '^]'.
Connection closed by foreign host.</p><p>这说明基本的网络连接是正常的，但在TLS握手阶段发生了问题。</p><h2 id=解决方案启用sni>解决方案：启用SNI</h2><p>经过排查，我们发现增加一行简单的配置就解决了问题：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span>require_sni <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>这个参数需要添加到HTTPS监听器的配置中。完整的Terraform配置差异如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>listener = {
</span></span><span style=display:flex><span>  frontend_ip   = &#34;appGwPrivateIpv4&#34;
</span></span><span style=display:flex><span>  frontend_port = 443
</span></span><span style=display:flex><span>  protocol      = &#34;Https&#34;
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ require_sni   = true
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>}
</span></span></code></pre></div><p>添加这一行后，服务立即恢复正常访问。</p><h2 id=为什么会这样sni是什么>为什么会这样？SNI是什么？</h2><p>SNI（Server Name Indication）是TLS协议的扩展，它允许客户端在SSL/TLS握手过程的早期阶段就指明它要连接的主机名。这使得服务器能够在同一个IP地址上提供多个不同域名的HTTPS服务，每个域名使用不同的SSL证书。</p><h3 id=sni工作原理>SNI工作原理</h3><p>SNI的工作流程如下：</p><ol><li>客户端发起HTTPS连接，在TLS握手的ClientHello消息中包含SNI扩展，指明目标主机名</li><li>服务器根据这个主机名选择正确的SSL证书</li><li>服务器使用选定的证书完成TLS握手</li></ol><pre class=mermaid>
  flowchart TD
    subgraph &#34;客户端&#34;
        Client[用户浏览器]
    end

    subgraph &#34;Azure应用网关&#34;
        AppGW[应用网关]
        subgraph &#34;Listener配置&#34;
            PublicIP[公网IP监听器]
            PrivateIP[私网IP监听器]
        end
        subgraph &#34;TLS处理&#34;
            SNI[&#34;SNI处理&lt;br&gt;(Server Name Indication)&#34;]
            Cert1[&#34;证书1&lt;br&gt;example.jiejue.ai&#34;]
            Cert2[&#34;证书2&lt;br&gt;jiejue.ai&#34;]
        end
    end

    subgraph &#34;后端服务&#34;
        Backend1[后端服务1]
        Backend2[后端服务2]
    end

    Client --&gt;|1.HTTPS请求&lt;br&gt;包含SNI信息| AppGW
    AppGW --&gt; PublicIP
    AppGW --&gt; PrivateIP
    PublicIP --&gt;|2a. 公网IP&lt;br&gt;访问| SNI
    PrivateIP --&gt;|2b. 私网IP&lt;br&gt;访问| SNI
    SNI --&gt;|3a. 匹配主机名| Cert1
    SNI --&gt;|3b. 匹配主机名| Cert2
    Cert1 --&gt;|4a. 使用证书1| Backend1
    Cert2 --&gt;|4b. 使用证书2| Backend2
</pre><h2 id=公网ip与私网ip的sni行为差异>公网IP与私网IP的SNI行为差异</h2><p>有趣的是，我们发现公网IP和私网IP环境下，Application Gateway处理SNI的方式存在差异：</p><pre class=mermaid>
  flowchart TD
    subgraph &#34;公网IP配置&lt;br&gt;require_sni = false&#34;
        C1[客户端] --&gt;|1.请求到公网IP| PG[应用网关&lt;br&gt;公网IP前端]
        PG --&gt;|2.TLS握手&lt;br&gt;没有SNI也能工作| PH[&#34;主机检查&lt;br&gt;(宽松)&#34;]
        PH --&gt;|3.选择默认证书| PB[后端服务]
    end

    subgraph &#34;私网IP配置&lt;br&gt;require_sni = false&#34;
        C2[客户端] --&gt;|1.请求到私网IP| VG[应用网关&lt;br&gt;私网IP前端]
        VG --&gt;|2.TLS握手&lt;br&gt;没有SNI信息| VH[&#34;主机检查&lt;br&gt;(严格)&#34;]
        VH --&gt;|3.无法确定证书&lt;br&gt;连接重置!| VB[后端服务]
    end

    subgraph &#34;私网IP配置&lt;br&gt;require_sni = true&#34;
        C3[客户端] --&gt;|1.请求到私网IP&lt;br&gt;包含主机名| SG[应用网关&lt;br&gt;私网IP前端]
        SG --&gt;|2.TLS握手&lt;br&gt;使用SNI信息| SH[&#34;主机检查&lt;br&gt;(严格)&#34;]
        SH --&gt;|3.正确匹配证书| SB[后端服务]
    end
</pre><ul><li><strong>公网IP环境</strong>：即使客户端不提供SNI信息（如直接通过IP访问），Application Gateway也能选择一个"默认"证书来完成TLS握手</li><li><strong>私网IP环境</strong>：如果客户端不提供SNI信息，Application Gateway会直接重置连接，导致TLS握手失败</li></ul><p>这种差异可能是由Azure内部实现或安全策略决定的，但这一行为在微软官方文档中并没有明确说明。</p><h2 id=关于sni参数的更多细节>关于SNI参数的更多细节</h2><p>在Azure Application Gateway的Terraform配置中，<code>require_sni</code>参数定义如下：</p><p class=mathjax>require_sni - (Optional) Should Server Name Indication be Required? Defaults to false.</p><p>虽然官方将其描述为可选参数，并默认为<code>false</code>，但在私网环境中，它实际上是必需的，特别是在以下情况：</p><ol><li>多个站点共享同一个应用网关</li><li>使用HTTPS协议</li><li>前端IP配置为私网IP</li></ol><h2 id=排查建议>排查建议</h2><p>如果你在Azure Application Gateway私网环境下遇到类似的连接重置问题，请尝试以下排查步骤：</p><ol><li>检查基本连接（使用telnet等工具）</li><li>验证证书配置是否正确</li><li><strong>检查SNI设置</strong>，确保HTTPS监听器上设置了<code>require_sni = true</code></li><li>确保客户端请求包含正确的主机名（而不是直接使用IP）</li></ol><h2 id=为什么azure-portal会自动处理这个问题>为什么Azure Portal会自动处理这个问题？</h2><p>有趣的是，如果你在Azure Portal中手动将Application Gateway的前端IP从公网切换到私网，Portal会自动启用SNI要求。这表明Microsoft意识到了这个行为差异，并在UI操作中进行了智能处理。</p><p>然而，在使用Terraform等IaC工具时，这种自动调整不会发生，需要手动添加<code>require_sni = true</code>配置。</p><h2 id=最佳实践建议>最佳实践建议</h2><p>基于我们的经验，建议采取以下最佳实践：</p><ol><li><strong>始终启用SNI</strong>：无论公网还是私网环境，都设置<code>require_sni = true</code></li><li><strong>使用域名访问</strong>：确保客户端通过域名而非IP直接访问服务</li><li><strong>明确在IaC中配置</strong>：在Terraform等代码中显式设置SNI参数</li><li><strong>文档化配置要求</strong>：在项目文档中注明这一关键配置</li></ol><h2 id=深入理解application-gateway的sni架构>深入理解：Application Gateway的SNI架构</h2><p>对于希望深入了解技术细节的读者，以下是Azure Application Gateway中SNI处理的架构图：</p><svg viewBox="0 0 900 500"><rect width="900" height="500" fill="#f9f9f9"/><rect x="100" y="50" width="700" height="400" rx="20" ry="20" fill="#f0f7ff" stroke="#0078d4" stroke-width="2" stroke-dasharray="5,5"/><text x="400" y="80" font-family="Arial" font-size="16" text-anchor="middle" fill="#0078d4">Azure Cloud Environment</text><rect x="20" y="200" width="100" height="80" rx="10" ry="10" fill="#fff" stroke="#666" stroke-width="2"/><text x="70" y="245" font-family="Arial" font-size="14" text-anchor="middle">客户端</text><rect x="200" y="150" width="500" height="200" rx="15" ry="15" fill="#e1ebf7" stroke="#0078d4" stroke-width="2"/><text x="450" y="175" font-family="Arial" font-size="16" text-anchor="middle" font-weight="bold" fill="#0078d4">应用网关 (Application Gateway)</text><rect x="220" y="190" width="120" height="140" rx="5" ry="5" fill="#fff" stroke="#666" stroke-width="1"/><text x="280" y="210" font-family="Arial" font-size="12" text-anchor="middle">前端IP配置</text><rect x="230" y="220" width="100" height="40" rx="5" ry="5" fill="#d4edda" stroke="#28a745" stroke-width="1"/><text x="280" y="245" font-family="Arial" font-size="12" text-anchor="middle">公网IP</text><rect x="230" y="270" width="100" height="40" rx="5" ry="5" fill="#f8d7da" stroke="#dc3545" stroke-width="1"/><text x="280" y="295" font-family="Arial" font-size="12" text-anchor="middle">私网IP</text><rect x="360" y="190" width="120" height="140" rx="5" ry="5" fill="#fff3cd" stroke="#ffc107" stroke-width="1"/><text x="420" y="210" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">SNI处理层</text><text x="420" y="230" font-family="Arial" font-size="10" text-anchor="middle">Server Name Indication</text><rect x="370" y="240" width="100" height="30" rx="5" ry="5" fill="#fff" stroke="#666" stroke-width="1"/><text x="420" y="260" font-family="Arial" font-size="10" text-anchor="middle">require_sni=false</text><rect x="370" y="280" width="100" height="30" rx="5" ry="5" fill="#fff" stroke="#666" stroke-width="1"/><text x="420" y="300" font-family="Arial" font-size="10" text-anchor="middle">require_sni=true</text><rect x="500" y="190" width="180" height="140" rx="5" ry="5" fill="#e2e3e5" stroke="#6c757d" stroke-width="1"/><text x="590" y="210" font-family="Arial" font-size="12" text-anchor="middle">SSL证书存储</text><rect x="510" y="220" width="160" height="30" rx="5" ry="5" fill="#fff" stroke="#6c757d" stroke-width="1"/><text x="590" y="240" font-family="Arial" font-size="10" text-anchor="middle">example.jiejue.ai</text><rect x="510" y="260" width="160" height="30" rx="5" ry="5" fill="#fff" stroke="#6c757d" stroke-width="1"/><text x="590" y="280" font-family="Arial" font-size="10" text-anchor="middle">jiejue.ai</text><rect x="510" y="300" width="160" height="30" rx="5" ry="5" fill="#fff" stroke="#6c757d" stroke-width="1"/><text x="590" y="320" font-family="Arial" font-size="10" text-anchor="middle">其他域名证书...</text><rect x="750" y="150" width="120" height="80" rx="10" ry="10" fill="#fff" stroke="#6c757d" stroke-width="2"/><text x="810" y="195" font-family="Arial" font-size="14" text-anchor="middle">后端服务 1</text><rect x="750" y="250" width="120" height="80" rx="10" ry="10" fill="#fff" stroke="#6c757d" stroke-width="2"/><text x="810" y="295" font-family="Arial" font-size="14" text-anchor="middle">后端服务 2</text><line x1="120" y1="240" x2="200" y2="240" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/><text x="160" y="230" font-family="Arial" font-size="10" text-anchor="middle">HTTPS请求</text><line x1="340" y1="240" x2="360" y2="240" stroke="#28a745" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="340" y1="290" x2="360" y2="290" stroke="#dc3545" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="480" y1="240" x2="500" y2="240" stroke="#ffc107" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="480" y1="290" x2="500" y2="290" stroke="#ffc107" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="680" y1="235" x2="750" y2="190" stroke="#6c757d" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="680" y1="275" x2="750" y2="290" stroke="#6c757d" stroke-width="2" marker-end="url(#arrowhead)"/><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#666"/></marker></defs><rect x="150" y="380" width="600" height="50" rx="5" ry="5" fill="#d1ecf1" stroke="#17a2b8" stroke-width="1"/><text x="450" y="410" font-family="Arial" font-size="12" text-anchor="middle" fill="#0c5460"><tspan x="450" dy="0">关键点: 私网IP环境中，require_sni=true 强制客户端提供主机名，</tspan><tspan x="450" dy="20">使应用网关能够正确选择SSL证书，避免连接重置问题</tspan></text></svg><p>SNI配置影响着整个TLS握手流程，特别是在多站点环境中。当<code>require_sni = true</code>时，应用网关严格要求客户端提供主机名信息，这不仅提高了安全性，还确保了正确的证书选择和请求路由。</p><h2 id=结论>结论</h2><p>在Azure Application Gateway的私网配置中，SNI参数扮演着关键角色，它不仅是一个可选的安全增强措施，而是确保服务正常运行的必要配置。理解公网和私网环境下的这种微妙差异，将帮助你避免不必要的故障排查时间，并设计出更健壮的云架构。</p><p>最后，这个案例提醒我们，即使是最简单的配置参数也可能对服务可用性产生重大影响，特别是在迁移或环境变更时，需要特别注意这些"默认"但关键的配置项。</p><p>你是否也遇到过类似的云服务配置问题？欢迎在评论区分享你的经验！</p></section><div class=divider></div><div class="flex flex-col md:flex-row justify-between gap-4 py-4"><a role=button class="btn btn-outline h-12" href=/2025/03/embedding-svg-in-hugo-blog-easy-way/ title=在Hugo博客中优雅地嵌入SVG图片：简单实用的方法><ion-icon name=chevron-back></ion-icon><div class="inline-flex flex-col items-start"><span class="text-base-content/60 text-xs font-normal">上一页</span>
<span class="max-w-48 truncate">在Hugo博客中优雅地嵌入SVG图片：简单实用的方法</span></div></a><a role=button class="btn btn-outline h-12" href=/2025/03/mcp-beginner-guide-finding-services/ title=MCP入门：告别微调，轻松找到开源服务><div class="inline-flex flex-col items-end"><span class="text-base-content/60 text-xs font-normal">下一页</span>
<span class="max-w-48 truncate">MCP入门：告别微调，轻松找到开源服务</span></div><ion-icon name=chevron-forward></ion-icon></a></div><div class=divider></div><section class=space-y-4><article><div id=tcomment></div><script src=https://cdn.jsdelivr.net/npm/twikoo@1.6.41/dist/twikoo.min.js></script><script>twikoo.init({envId:"https://6dhzwvtyqz753zhpkrvnnydhlm0vubmy.lambda-url.ap-east-1.on.aws/",el:"#tcomment",region:"ap-east-1",path:"/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/",lang:"zh-CN"})</script></article></section></article></div><div class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#问题场景>问题场景</a></li><li><a href=#解决方案启用sni>解决方案：启用SNI</a></li><li><a href=#为什么会这样sni是什么>为什么会这样？SNI是什么？</a><ul><li><a href=#sni工作原理>SNI工作原理</a></li></ul></li><li><a href=#公网ip与私网ip的sni行为差异>公网IP与私网IP的SNI行为差异</a></li><li><a href=#关于sni参数的更多细节>关于SNI参数的更多细节</a></li><li><a href=#排查建议>排查建议</a></li><li><a href=#为什么azure-portal会自动处理这个问题>为什么Azure Portal会自动处理这个问题？</a></li><li><a href=#最佳实践建议>最佳实践建议</a></li><li><a href=#深入理解application-gateway的sni架构>深入理解：Application Gateway的SNI架构</a></li><li><a href=#结论>结论</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 爱解决</p><p>硅基生物幼稚园</p></div><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
本站总访问量 <span id=busuanzi_value_site_pv></span>
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user"></i>
本站访客数 <span id=busuanzi_value_site_uv></span></span></section></span></section></script><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 爱解决</p><p>硅基生物幼稚园</p></div><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
本站总访问量 <span id=busuanzi_value_site_pv></span>
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user"></i>
本站访客数 <span id=busuanzi_value_site_uv></span></span></section></span></section></script><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyy年MM月dd日 HH:mm")})}</script><script type=module>
      import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
      mediumZoom('#dream-single-post-content img', {
        background: 'oklch(var(--b1))',
        margin: 24,
      })
    </script><script type=module>
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
      </script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-S0KCH9BW4F"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-S0KCH9BW4F")}</script><script type=module src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js></script><script nomodule src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js></script></body></html>