---
title: "KQL: таинственный инструмент для анализа журналов облачных сервисов"
date: 2025-03-25T20:16:20+04:00
slug: "kusto-query-language-for-log-analysis"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250325201800819.webp"
tags:
  - "навык"
  - "анализ данных"
  - "Лазурь"
  - "обработка журнала"
---

Отправляясь в плавание по океану облачных вычислений, вам не обойтись без средств навигации. Когда ваш сервис внезапно падает, пользователи сообщают вам о медленном отклике системы или срабатывают предупреждения системы безопасности, вам нужен мощный способ быстро определить первопричину проблемы. Вот почему так важно овладеть мощным инструментом, которым является KQL (Kusto Query Language).

<! -еще-->

## Что такое KQL?

KQL означает "Kusto Query Language", язык запросов, предназначенный для анализа журналов и временных рядов данных. Изначально он был разработан компанией Microsoft для анализа масштабных данных в локальных сетях, а теперь является основным компонентом Azure Log Analytics, Azure Data Explorer и других облачных служб Microsoft.

Особенность KQL заключается в том, что он сочетает в себе возможности SQL для создания запросов с моделью конвейеризации, подобной PowerShell, и создает интуитивно понятный и мощный язык анализа данных.

## Интересные источники для Kusto

Прежде чем мы погрузимся в синтаксис KQL, давайте поговорим о другом: вам может быть интересно, откуда взялось название "Kusto".

Интересно, что Кусто назван в честь собаки-поводыря Тиресия, слепого пророка в греческой мифологии. На иврите собака называется "Кусто". Название имеет более глубокий смысл - подобно собаке-поводырю, ведущей своего хозяина, KQL помогает аналитикам находить "прозорливые" идеи в огромных массивах данных.

Почему американская компания выбрала для своего продукта название на иврите? Оно отражает мультикультурную природу Microsoft как глобального предприятия. У Microsoft есть крупные центры исследований и разработок в Тель-Авиве и Хайфе, Израиль, и вполне вероятно, что эти команды внесли значительный вклад в проект Kusto, дав ему уникальное название.

## Основной синтаксис KQL

Основная идея KQL заключается в объединении нескольких операций в конвейер (с использованием нотации `|`), где каждая операция обрабатывает результат предыдущего шага. Это похоже на концепцию конвейера в командной строке Unix/Linux или PowerShell.

### Базовая структура

Типичный KQL-запрос обычно начинается с источника данных, за которым следует серия операций:

```kql
TableName
| where Condition
| extend NewColumn = Expression
| project FieldsToKeep
| summarize Count=count() by GroupByField
```.

Такая структура делает сложную логику анализа понятной и читаемой.

### Примеры из реального мира

Давайте поймем возможности KQL на реальном примере. Предположим, вам нужно проанализировать журналы приложений в службе Azure Kubernetes, чтобы выявить шаблоны ошибок, с которыми сталкивается конкретный пользователь:

```kql
ContainerLogV2
| where TimeGenerated between (datetime(2024-11-01) .. datetime(2025-02-01))
| where LogMessage contains '"completed_request": false'
| where LogMessage contains ("abc123-user-name")
| extend jsonPart = extract("sending event in Event Hub--(.+) \\| \\{\\}", 1, tostring(LogMessage))
| where isnotempty(jsonPart)
| extend parsed = parse_json(jsonPart)
| extend model = tostring(parsed.model)
| extend error_code = tostring(parsed.error_code)
| extend error_msg = tostring(parsed.error_message)
| where isnotempty(model) and isnotempty(error_code)
| summarize count() by model, error_code, error_msg
| order by count_ desc
```.

Что сделал этот запрос?

1. выбирает журналы контейнеров за определенный промежуток времени
2. отфильтровывает неудачные запросы и конкретных пользователей
3. извлекает часть текста журнала в формате JSON
4. разбирает JSON и извлекает ключевые поля
5. группировка статистики по модели, коду ошибки и сообщению об ошибке
6. сортировка по количеству в порядке убывания

С помощью этого запроса можно быстро определить, какие модели и комбинации ошибок встречаются чаще всего, что позволит определить приоритетность наиболее распространенных проблем.

## Сила KQL

KQL - это гораздо больше, чем простая фильтрация и группировка. Вот некоторые из его мощных возможностей:

### 1. Гибкое извлечение и преобразование данных

```kql
| extend extracted = extract("pattern(.*)", 1, field)
| parse field with "prefix" variable "suffix"
```.

KQL предоставляет несколько способов извлечения информации из неструктурированного текста, включая сопоставление регулярных выражений и разбор шаблонов.

### 2. Мощная обработка JSON

```kql
| extend parsed = parse_json(jsonField)
| project value = parsed.some.nested.property
```.

Для полуструктурированных журналов KQL позволяет легко разбирать вложенный JSON и получать доступ к свойствам внутри него.

### 3. Разбор временных данных

```kql
| summarize count() by bin(TimeGenerated, 1h)
| render timechart
```_.

KQL предоставляет специализированные функции для анализа временных рядов, такие как биннинг времени и специальные опции визуализации.

### 4. Комплексное агрегирование

```kql
| summarize 
    count(),
    avg(metric),
    percentile(latency, 95)
  by service, region
```.

KQL поддерживает различные функции агрегирования, чтобы помочь вам полностью понять распределение данных.

## KQL по сравнению с другими языками запросов

KQL имеет уникальные преимущества перед другими популярными языками анализа журналов:

- По сравнению с SQL: KQL более дружелюбен к полуструктурированным данным и обработке текста.
- По сравнению с Elasticsearch DSL: KQL имеет более чистый синтаксис и более плавную кривую обучения.
- Модель конвейеризации KQL делает сложные запросы более простыми для построения и понимания, чем язык поиска Splunk.

## Практические сценарии применения

KQL особенно полезен в различных сценариях:

1. **Устранение неполадок**: быстрое обнаружение ошибок и аномалий в производственных средах
2. **Анализ производительности**: выявление узких мест в системе и возможностей оптимизации
3. **Мониторинг безопасности**: обнаружение подозрительных действий и потенциальных угроз безопасности
4. **Анализ поведения пользователей**: понимание того, как пользователи взаимодействуют с приложениями.
5. **Планирование пропускной способности**: прогнозирование будущих потребностей в ресурсах на основе исторических тенденций

## Учебные ресурсы

Если вы заинтересовались KQL, следующие ресурсы помогут вам быстро освоиться:

1. Официальная документация Microsoft: [Kusto Query Language Overview](https://docs.microsoft.com/zh-cn/azure/data-explorer/kusto/query/)
2. [Azure Log Analytics Workshop](https://portal.azure.com/#blade/Microsoft_Azure_Monitoring_Logs/DemoLogsBlade)
3. [Быстрый контрольный список KQL](__PROTECTED_LINK_URL__9__)

## Заключение

В эпоху облачных технологий умение эффективно анализировать журналы уже не является чем-то необязательным, а становится необходимым навыком. kQL, язык, разработанный специально для анализа журналов облачных сервисов, предоставляет лаконичный, но мощный синтаксис для решения сложных задач анализа. Независимо от того, являетесь ли вы операционным инженером, разработчиком или аналитиком безопасности, владение языком KQL значительно повысит вашу эффективность в устранении проблем и получении новых знаний.

В следующий раз, когда вы будете просматривать журналы в Azure, попробуйте силу KQL - возможно, вы, как и я, влюбитесь в эту "собаку-поводыря" из древнееврейской мифологии, которая ведет вас через море данных, чтобы найти путь к истине.

Вам интересно попробовать использовать KQL для создания панели мониторинга логов, чтобы следить за состоянием системы в режиме реального времени? Это отличная возможность применить свои знания KQL на практике.
