---
title: "Настройка поддержки языка KDL в Neovim"
date: 2025-03-29T19:56:46+04:00
slug: "configure-kdl-support-in-neovim"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250329200248895.webp"
tags:
  - "Neovim"
  - "LazyVim"
  - "KDL"
  - "настроить"
---

Недавно я столкнулся с KDL (Kdl Document Language), развивающимся языком документации, и мне понадобилось редактировать KDL-файлы в Neovim. В этой статье мы расскажем, как добавить поддержку языка KDL в Neovim (особенно в конфигурации LazyVim), чтобы включить подсветку синтаксиса и функции аннотирования.

<! --подробнее-->

## Введение в язык KDL

KDL (произносится как "cuddle") - это развивающийся язык малых документов с семантикой узлов, подобной XML, но с синтаксисом, больше похожим на команды CLI. Он предназначен для использования в качестве формата сериализации и языка конфигурации, аналогичного JSON, YAML или XML.

Простой пример KDL:

```kdl
// 这是KDL的注释
package {
  name "my-package"
  version "1.0.0"
  
  dependencies {
    lodash "^3.2.1" optional=#true
  }
  
  scripts {
    build """
      echo "Building package"
      npm run compile
    """
  }
}
```.

KDL характеризуется ясным и лаконичным синтаксисом, сохраняя при этом хорошие структурированные свойства, что делает его идеальным для использования в качестве формата конфигурационных файлов.

## Добавление поддержки KDL в Neovim

Добавление поддержки KDL в Neovim требует двух основных частей:

1. подсветка синтаксиса (через Tree-sitter)
2. поддержка ярлыков аннотаций

### Подготовка

Убедитесь, что у вас установлен [LazyVim](https://www.lazyvim.org/) или хотя бы [lazy.nvim](https://github.com/folke/lazy.nvim), настроенный как менеджер плагинов.

### Создайте файл конфигурации

В LazyVim нам нужно создать специальный файл конфигурации плагина. Обычно новый файл создается в директории `~/.config/nvim/lua/plugins/`.

```bash
mkdir -p ~/.config/nvim/lua/plugins/
touch ~/.config/nvim/lua/plugins/kdl.lua
```

### Настройте поддержку KDL

Откройте файл `kdl.lua`, который вы только что создали, и добавьте следующее:

```lua
return {
  -- 添加KDL语言支持到Neovim
  {
    "nvim-treesitter/nvim-treesitter",
    opts = function(_, opts)
      -- 将KDL添加到ensure_installed列表
      vim.list_extend(opts.ensure_installed or {}, {
        "kdl",
      })
    end,
  },

  -- 配置KDL文件的注释字符串
  {
    "JoosepAlviste/nvim-ts-context-commentstring",
    opts = function(_, opts)
      if not opts.config then opts.config = {} end
      opts.config.kdl = { __default = "// %s" }
      return opts
    end,
  },
}
```

Этот файл конфигурации делает две вещи:

1. заставить `nvim-treesitter` установить и загрузить парсер языка KDL, чтобы обеспечить подсветку синтаксиса
2. настраивает плагин `nvim-ts-context-commentstring`, чтобы он знал, что файлы KDL используют `//` в качестве префикса комментария

### Конфигурация приложения

После сохранения файла перезапустите Neovim или выполните следующую команду для синхронизации плагина:

```
:Lazy sync
```.

Когда вы впервые открываете KDL-файл, Tree-sitter автоматически устанавливает парсер языка KDL.

## Заметки о конфигурации

### Конфигурация Tree-sitter

```lua
{
  "nvim-treesitter/nvim-treesitter",
  opts = function(_, opts)
    vim.list_extend(opts.ensure_installed or {}, {
      "kdl",
    })
  end,
}
```.

Этот код добавляет парсер `kdl`, изменяя опцию `ensure_installed` из `nvim-treesitter` через систему конфигурации LazyVim. Таким образом, система автоматически загрузит и скомпилирует парсер Tree-sitter от KDL, когда он вам впервые понадобится.

### Конфигурация функции аннотаций

```lua
{
  "JoosepAlviste/nvim-ts-context-commentstring",
  opts = function(_, opts)
    if not opts.config then opts.config = {} end
    opts.config.kdl = { __default = "// %s" }
    return opts
  end,
}
```.

Эта конфигурация указывает KDL-файлу плагина `nvim-ts-context-commentstring` использовать `// ` в качестве префикса комментария. `%s` - это заполнитель, указывающий, что аннотированное содержимое будет размещено в этой позиции.

При такой настройке, когда вы используете команду комментария, такую как `gcc` (для комментирования текущей строки) или `gc` (для комментирования выбранного содержимого) в KDL-файле, Neovim правильно использует `//` в качестве префикса комментария. CODE_19__ в качестве флага комментария.

## Опыт использования

После завершения настройки, открыв файл `.kdl`, вы увидите:

1. подсветка синтаксиса работает правильно, с различными цветами для ключевых слов, строк, комментариев и т. д.
2. ярлыки комментариев (например, `gcc`) позволяют нормально добавлять и удалять комментарии

## Возможные проблемы и решения

Если вы столкнулись со следующей проблемой:

### Нет подсветки синтаксиса

Убедитесь, что:
- Tree-sitter правильно установлен
- Установлен парсер KDL (вид `:TSInstallInfo`)
- Расширение файла `.kdl` или тип файла установлены правильно

### Не работают ярлыки аннотаций

Убедитесь, что:
- `nvim-ts-context-commentstring` правильно настроен.
- Используемый вами плагин аннотаций (например, `Comment.nvim` или `mini.comment`) работает правильно
- Файл правильно распознан как тип KDL

## Резюме

С помощью простой конфигурации мы можем добавить поддержку языка KDL в Neovim/LazyVim, включив подсветку синтаксиса и аннотацию. С развитием языка KDL в будущем может появиться больше инструментов и плагинов для KDL, но эта базовая конфигурация может удовлетворить большинство потребностей в редактировании.

Если вы часто используете KDL, эта конфигурация значительно повысит эффективность редактирования. Надеюсь, эта статья будет вам полезна!

## Связанные ресурсы

- [Официальный репозиторий KDL](__PROTECTED_LINK_URL__29__)
- [Tree-sitter KDL parser](https://github.com/tree-sitter-grammars/tree-sitter-kdl)
- [nvim-treesitter](https://github.com/nvim-treesitter/nvim-treesitter)
- [nvim-ts-context-commentstring](https://github.com/JoosepAlviste/nvim-ts-context-commentstring)
