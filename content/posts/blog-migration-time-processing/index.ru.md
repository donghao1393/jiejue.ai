---
title: "Работа со временем при миграции блогов: от истории Git к метаданным"
date: 2025-02-02T11:26:52+04:00
slug: "blog-migration-time-processing"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250202113321139.webp"
tags:
  - "навык"
  - "блог (заимствованное слово)"
  - "Ракушка"
  - "Git"
---

Во время миграции блоговой системы время создания постов часто становится легко упускаемой из виду, но необходимой проблемой. В этой статье мы поделимся практическим опытом, как восстановить и сохранить время создания статей с помощью информации об истории Git и сценариев оболочки во время миграции с Zola на Hugo.

<! --подробнее-->

## Предыстория

В процессе переноса блога с Zola на Hugo я столкнулся с двумя проблемами, касающимися времени публикации постов:

1. в связи с изменением репозитория время файлов в Zola стало актуальным, и мне нужно получить первоначальное время создания статьи из истории Git.
2. Hugo необходимо использовать определенный формат временных меток в заголовках статей.

Эти две проблемы кажутся простыми, но на практике они столкнулись с неожиданными техническими трудностями.

## Проблема 1: Восстановление времени файлов из истории Git

Решение первой проблемы заключается в использовании информации журнала Git'а для получения времени самой ранней фиксации файла. Этот процесс включает в себя несколько ключевых шагов:

1. использование `git log` для получения истории коммитов файла
2. разбор информации о дате
3. преобразование даты в правильный формат временной метки
4. обновление времени файла с помощью команды `touch`

Давайте посмотрим на код реализации:

```fish
for file in content/posts/*.md
    set gitdate (git log -1 --format="%ad" -- $file)
    echo "处理文件: $file"
    echo "Git日期: $gitdate"
    
    # 解析年份
    set year (string match -r '\d{4}' $gitdate)
    
    # 解析月份
    set month_name (string match -r '\s([A-Za-z]{3})\s' $gitdate)[2]
    switch $month_name
        case Jan; set month "01"
        case Feb; set month "02"
        case Mar; set month "03"
        case Apr; set month "04"
        case May; set month "05"
        case Jun; set month "06"
        case Jul; set month "07"
        case Aug; set month "08"
        case Sep; set month "09"
        case Oct; set month "10"
        case Nov; set month "11"
        case Dec; set month "12"
    end
    
    # 解析日期和时间
    set day (string match -r '\s(\d{1,2})\s' $gitdate)[2]
    set hour (string match -r '(\d{2}):\d{2}:\d{2}' $gitdate)[2]
    set minute (string match -r '\d{2}:(\d{2}):\d{2}' $gitdate)[2]
    set second (string match -r '\d{2}:\d{2}:(\d{2})' $gitdate)[2]
    
    # 格式化时间戳
    set timestamp "$year$month$day$hour$minute.$second"
    echo "设置时间戳: $timestamp"
    touch -t $timestamp $file
end
```

Этот скрипт использует возможности оболочки fish shell для обработки сопоставления и преобразования строк, чтобы создать формат временных меток, удовлетворяющий требованиям команды `touch`.

## Выпуск 2: Обновление времени на первой странице статей Hugo

Вторая проблема была связана с установкой правильного формата времени в frontmatter статьи Hugo. В этом процессе мы столкнулись с некоторыми интересными техническими деталями:

Во-первых, при попытке получить время напрямую с помощью __PROTECTED_INLINE_CODE__7__ возникла проблема с форматированием:

```bash
$ gstat -c '%Y-%m-%dT%H:%M:%S' article.md
1738439771-/-16777232T?:?:?  # 错误的输出格式
```

После отладки мы обнаружили, что для получения и форматирования времени нужно использовать другой метод. Окончательное решение было таким:

1. использовать `gstat --format="%W"` для получения исходных временных меток
2. конвертировать временные метки в формат ISO 8601 с помощью __PROTECTED_INLINE_CODE__9__.
3. используйте `sed` для обработки формата часового пояса

Окончательная реализация сценария выглядит следующим образом:

```fish
#!/usr/bin/env fish

# 递归查找所有 index.md 文件
for md_file in (fd "index_?.*.md")
    set -l md_dir (dirname $md_file)
    # 获取文件的创建时间，格式化为 ISO 8601
    set create_time (gstat --format="%W" $md_dir | xargs -I{} gdate -d "@{}" '+%Y-%m-%dT%H:%M:%S%z' | sed 's/\([+-][0-9]\{2\}\)\([0-9]\{2\}\)/\1:\2/')
    
    # 更新frontmatter
    # 使用 sed 替换 date: 行
    # 匹配 date: YYYY-MM-DD 格式，替换为带时间的格式
    sed -i '' -E "s/^date: ([0-9]{4}-[0-9]{2}-[0-9]{2})/date: $create_time/" $md_file
    
    echo "Updated $md_file with date: $create_time"
end
```.

## Проблема 3: Отображение времени с точностью до минуты

После завершения базового переноса времени мы обнаружили новое требование: Hugo по умолчанию отображает только год, месяц и день, поэтому для нескольких статей, опубликованных в один и тот же день, он не может отразить их порядок старшинства. Чтобы решить эту проблему, нам нужно настроить формат отображения времени в Hugo.

Изменив конфигурационный файл Hugo, мы обеспечили более точное отображение времени:

```toml
[params.experimental]
  jsDate = true
  jsDateFormat = "yyyy年MM月dd日 HH:mm"
```.

Это изменение дает несколько преимуществ:

1. более точное отображение хронологии статей
2. для нескольких статей, опубликованных в один и тот же день, можно четко указать порядок публикации.
3. предоставление читателям более подробной информации о времени, особенно для недавно опубликованных статей.

## Объяснение технических моментов

В процессе решения этих трех задач мы столкнулись с несколькими ключевыми техническими деталями и решили их:

1. Разбор формата даты в Git
   - Формат вывода даты в Git'е специфичен, и его компоненты должны быть правильно разобраны.
   - При извлечении компонентов даты с помощью регулярных выражений необходимо учитывать различные граничные случаи

2. преобразование временных меток
   - Преобразование временных меток Unix в человекочитаемые форматы.
   - Преобразование между различными форматами (формат Git, формат команд touch, формат ISO 8601)

3. Настройка отображения времени в Hugo
   - Функции форматирования даты с помощью JavaScript
   - Включение экспериментальных функций в конфигурации темы
   - Баланс между точностью и читабельностью отображения времени

## Извлеченные уроки

Это упражнение по обработке времени преподало нам несколько важных уроков:

1. при работе с вопросами, связанными со временем, всегда полезно сначала проверить все спецификации форматирования.
2. при использовании инструментов командной строки тщательно проверяйте формат вывода и не принимайте его как должное
3. при написании скриптов учитывайте обработку ошибок и граничные случаи
4. регулярные выражения - мощный инструмент для обработки сложных строк, но использовать их нужно с осторожностью.
5. отображение времени на сайте - это не только технический вопрос, но и вопрос удобства для пользователя.

## Место для улучшения

Несмотря на то, что текущее решение удовлетворяет потребностям, есть несколько возможных направлений для улучшения:

1. добавить обработку ошибок и ведение журнала
2. поддержка большего количества форматов времени и обработка часовых поясов
3. добавить механизм резервного копирования для предотвращения случайных модификаций файлов
4. оптимизировать производительность, особенно при работе с большим количеством файлов
5. рассмотреть возможность добавления более гибких настроек отображения времени

## Расширенное мышление

Этот практический пример также открывает нам глаза на некоторые более широкие сценарии использования технологии:

1. аналогичный подход к обработке времени может быть полезен в других типах миграции контента
2. информация об истории Git может быть использована не только для восстановления времени, но и для извлечения других метаданных.
3. Shell-скрипты, хотя и "старые", все еще являются одним из наиболее эффективных инструментов для автоматизации подобных специфических задач.
4. Баланс между точностью и читаемостью отображения времени - это вопрос пользовательского опыта, о котором стоит подумать.

Используя эти скрипты и опыт, мы сможем в будущем более комфортно решать вопросы, связанные со временем, при подобных переносах блогов или управлении контентом. Конечно, технологии постоянно развиваются, и наше решение должно идти в ногу со временем, совершенствуясь и оптимизируясь.
