---
title: "Файловая система Linux: от инода к линковке"
date: 2025-04-06T18:16:06+04:00
slug: "linux-filesystem-internals"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250406181945788.webp"
tags:
  - "Linux"
  - "файловая система"
  - "Технические принципы"
---

Вы когда-нибудь были озадачены поведением команд Linux? Например, почему команда __PROTECTED_INLINE_CODE__6__ удаляет не только связанные, но и обычные файлы? Почему после удаления некоторых файлов место на жестком диске освобождается не сразу? Эти вопросы тесно связаны с принципами работы файловой системы. В этой статье мы рассмотрим основные концепции файловой системы Linux, чтобы помочь вам понять механизмы работы файлов, каталогов и ссылок.

<! -еще-->

## Из запутанной операции __PROTECTED_INLINE_CODE__7__.

В системах Linux/Unix для удаления файлов мы обычно используем команду `rm`. Однако есть и другая, менее используемая команда: `unlink`. Буквально, кажется, что она только "отсоединяет", но на самом деле она удаляет обычные файлы, что часто вызывает удивление.

Вот типичный сценарий:

```bash
# 创建测试文件和目录
touch test
mkdir testfolder
cp test testfolder/

# 查看文件信息
stat testfolder/test
# 显示这是个常规文件，链接数为2

# 使用unlink删除
unlink testfolder/test

# 测试目录现在为空
ls testfolder/
```.

Почему команда под названием "разблокировать" удаляет и обычные файлы? Чтобы понять это, нам нужно углубиться в базовые концепции файловой системы.

## Основные понятия файловой системы: inode

### Что такое инод?

Считайте, что inode - это "удостоверение личности" файловой системы. При создании каждому файлу присваивается уникальный номер inode, в котором хранится почти вся информация о файле, **за исключением имени файла**:

- Размер файла
- Информация о владельце и разрешениях
- временные метки (время доступа, модификации, изменения)
- Указатель на фактический блок данных
- Количество ссылок (сколько имен файлов указывают на инод)

Важно отметить, что иноды не хранят имена файлов. Имена файлов хранятся в структуре каталогов.

```mermaid
graph TD
    A[文件系统] --> B[inode表]
    A --> C[数据块区域]
    B --> D[inode #1]
    B --> E[inode #2]
    B --> F[inode #3]
    D -->|指向| G[数据块]
    E -->|指向| H[数据块]
    F -->|指向| I[数据块]
    J[目录项] -->|映射| D
    K[目录项] -->|映射| E
    L[目录项] -->|映射| F
```.

### Что такое каталог?

В файловой системе Linux каталог сам по себе является специальным файлом. Содержимое каталога - это серия отношений отображения, которые связывают имена файлов с соответствующими номерами inode. Когда мы обращаемся к файлу, система:

1. найдет имя файла в файле каталога
2. получит соответствующий номер инода
3. найдет метаданные и расположение блока данных файла по номеру inode
4. прочитать или записать содержимое файла

Это объясняет, почему в Linux один и тот же файл может иметь несколько имен (жестких ссылок), а имя файла и его содержимое хранятся отдельно.

## Секреты линковки: жесткие и мягкие ссылки

Linux предоставляет два различных типа механизмов связывания: жесткие ссылки и мягкие ссылки (символические ссылки). Функционально они кажутся похожими, но в основе лежат совершенно разные принципы.

### Жесткие ссылки: несколько имен файлов, имеющих общий инод

Жесткие ссылки - это несколько имен файлов, указывающих на один и тот же инод. Когда создается жесткая ссылка, она фактически создает новую запись в каталоге, указывающую на существующий инод.

```bash
# 创建一个文件
echo "内容" > original.txt

# 创建硬链接
ln original.txt hardlink.txt

# 两个文件名指向同一个inode
ls -i original.txt hardlink.txt
```.

Характеристики жестких ссылок:

- Имеют один и тот же номер inode.
- Изменение содержимого любой ссылки влияет на все жесткие ссылки.
- Количество ссылок на инод показывает, сколько имен файлов на него указывают.
- Данные файла освобождаются только после удаления всех жестких ссылок (количество ссылок равно 0).
- Жесткие ссылки нельзя создавать в разных файловых системах
- Жесткие ссылки не могут быть созданы для каталогов (за исключением `.` и `..`)

### Мягкие ссылки: файлы-указатели

Мягкая ссылка (символическая ссылка) - это особый тип файла, содержимое которого представляет собой путь к другому файлу. Она похожа на ярлык в Windows.

```bash
# 创建软链接
ln -s original.txt symlink.txt

# 查看软链接的内容
readlink symlink.txt  # 显示 original.txt
```.

Характеристики мягкой ссылки:

- Имеет отдельный инод от целевого файла.
- Содержимое мягкой ссылки - это путь к целевому файлу.
- Размер мягкой ссылки обычно равен длине строки пути.
- Когда целевой файл удаляется, мягкая ссылка продолжает существовать, но становится "висячей".
- Может создаваться в разных файловых системах
- Может указывать на каталог

Может указывать на каталоги ```mermaid
graph TD
    subgraph "硬链接"
    A[文件名1] -->|指向| C[inode #42]
    B[文件名2] -->|指向| C
    C -->|指向| D[数据块]
    end
    
    subgraph "软链接"
    E[软链接文件名] -->|指向| F[inode #43]
    F -->|指向| G[数据块: #quot;/path/to/target#quot;]
    G -.->|引用| H[目标文件]
    end
```

## Правда о команде `unlink`

Теперь мы можем понять, как работает команда `unlink`. Команда `unlink` - это прямая обертка для базового системного вызова, который работает:

1. удалить запись с именем файла из каталога
2. уменьшить количество ссылок в соответствующем узле
3. пометить узел и блок данных как восстанавливаемые, если счетчик ссылок становится равным 0

Таким образом, будь то обычный файл, жесткая или мягкая ссылка, `unlink` просто выполняет одну и ту же операцию: удаляет связь имени файла с инодом. Вот почему `unlink` может удалять любые типы файлов, а не только файлы со ссылками.

```bash
# 查看文件的链接数
stat test
# 如果Links显示为1，unlink后文件数据会被释放
# 如果Links大于1，unlink后文件数据仍然存在，只是少了一个访问路径
```

## Разница между `rm` и `unlink`

Команда `rm` фактически вызывает системный вызов `unlink()`, но она предоставляет больше функциональности:

- Может удалять несколько файлов одновременно
- Обеспечивает интерактивное подтверждение (опция `-i`)
- Поддерживает принудительное удаление (опция `-f`).
- Поддерживается рекурсивное удаление каталогов (опция __PROTECTED_INLINE_CODE__23__).
- Больше проверок безопасности

Поэтому рекомендуется использовать `rm` вместо `unlink` для повседневного использования, особенно при работе с важными файлами.

## Реализации файловых систем на различных носителях

Механизм inode файловой системы реализован по-разному на разных носителях:

### Традиционный жесткий диск (HDD)

На традиционных механических жестких дисках инод косвенно связан с физическим местом хранения данных:
- Инод хранит логические указатели на блоки данных.
- Драйвер файловой системы преобразует эти логические блоки в физические колонки/сектора.
- Для поиска файлов требуются физические запросы, что является одним из узких мест в производительности жестких дисков.

### Твердотельные накопители (SSD)

Файловая система на твердотельных дисках сохраняет систему inode с точки зрения логической структуры, но базовая реализация сильно отличается:
- Твердотельные накопители отображают адреса логических блоков на физические страницы NAND с помощью Flash Translation Layer (FTL).
- Механический поиск отсутствует, поэтому производительность случайного доступа значительно повышается.
- Поддержка команды TRIM позволяет операционной системе уведомлять SSD о том, что эти блоки могут быть восстановлены при удалении файла.
- Внутренний механизм выравнивания износа перераспределяет данные, чтобы избежать перезаписи отдельных блоков памяти.

## Кроссплатформенное сравнение: Windows vs Linux

Эти концепции файловой системы в основном применимы к системам Unix/Linux, в Windows используется другая структура файловой системы:

- Windows NTFS использует главную файловую таблицу (MFT), а не систему инодов.
- Файловые записи NTFS содержат атрибуты, а не простые указатели на блоки данных.
- Windows поддерживает как жесткие, так и символические ссылки, но использует их реже.
- Windows обычно использует механизм корзины, а не удаляет файлы напрямую.
- Команды удаления используют `del`, а не `rm` или `unlink`.

## Практический совет

Понимание основополагающих принципов работы файловой системы позволяет нам выработать некоторые практические рекомендации:

1. Для повседневного использования предпочитайте `rm`, а не `unlink`.
2. используйте `rm -i` для получения подтверждения удаления важных файлов.
3. используйте команду `stat` для просмотра количества ссылок и других метаданных о файле.
4. понимайте разницу между жесткими и мягкими ссылками и выбирайте нужный тип ссылки для нужного сценария.
5. создавайте резервные копии важных данных, особенно перед выполнением сложных операций с файловой системой.

Поняв эти концепции файловой системы, вы сможете более безопасно и эффективно управлять файлами в системе Linux, избегать случайной потери данных и лучше понимать поведение различных команд файловых операций.

## Размышления о проблемах

Что происходит, когда вы удаляете файл, открытый процессом? Освобождаются ли сразу данные файла? Попробуйте запустить программу, которая открывает файл, а затем удаляет его на другом терминале, понаблюдайте за поведением системы и посмотрите, сможете ли вы объяснить это явление с помощью знаний о inode и связывании, как мы уже обсуждали.

<! -- Добавьте сюда диаграмму структуры файловой системы, показывающую взаимосвязь между инодами, блоками данных и записями каталогов -->
