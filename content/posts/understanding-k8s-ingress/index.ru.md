---
title: "Объяснение для разработчиков: почему прямой доступ к IP-адресу Kubernetes Ingress возвращает 404"
date: 2025-03-18T23:04:16+04:00
slug: "understanding-kubernetes-ingress-for-developers"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250318230709119.webp"
tags:
  - "Kubernetes"
  - "ретикуляция"
  - "Навыки развития"
---

Как инженер-разработчик, вы когда-нибудь сталкивались с ситуацией, когда ваше приложение развернуто на Kubernetes, но почему-то прямой доступ к IP-адресу сервиса всегда возвращает ошибку 404? В этой статье мы расскажем о принципе работы Ingress в Kubernetes и его использовании в доступной форме на практическом примере.

<! --подробнее-->

## Сценарий проблемы: Почему прямой доступ к IP-адресу всегда 404?

Представьте себе такой сценарий: ваша команда разработала сервис REST API, развернутый в кластере Kubernetes. В тестовой среде все работает хорошо, если обращаться к нему через определенное доменное имя (например, __PROTECTED_INLINE_CODE__9__), но иногда, для быстрого тестирования, вы хотите обратиться к нему напрямую, используя IP-адрес, и всегда получаете ошибку 404.

Например, вы выполняете следующую команду:

```bash
curl http://10.18.17.64/request
```

Возвращается результат:

```html
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>
```.

Что здесь происходит? Почему один и тот же сервис работает с доменным именем, но не работает с IP-адресом?

## ```html
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>
``` Что такое Ingress, считайте его "умным привратником"?

Прежде чем мы сможем объяснить, почему, нам нужно понять концепцию Ingress в Kubernetes.

Если вы раньше занимались только локальной разработкой, считайте, что Ingress - это "умный привратник" или "администратор". Представьте, что вы пришли в офисное здание с несколькими компаниями:

- **Охранник на главном входе в здание** = контроллер Ingress (с фиксированным IP-адресом)
- **Многочисленные компании на разных этажах** = различные службы внутри кластера
- **Форма регистрации посетителей** = конфигурация правил входа

Когда вы приходите в офисное здание, охранник (Ingress) сначала спросит: "Какую компанию вы ищете?". Только после вашего ответа охранник скажет вам точный этаж и номер комнаты. Если вы не скажете, какая компания вам нужна, охранник откажет вам в доступе (возврат к 404).

**Вот почему прямой доступ к IP-адресу возвращает 404**: потому что вы только постучали в дверь (IP-адрес), но не сказали охраннику (Ingress), в какую компанию вы хотите попасть (Host header).

## Как работает Ingress? Картинка стоит тысячи слов

На следующей схеме показан основной рабочий процесс Ingress:

```mermaid
flowchart TD
    A[外部请求] --> B[Ingress Controller\n运行在特定IP]
    B --> C{检查Host头}
    C -->|匹配 api.jiejue.ai| D[API服务]
    C -->|匹配 web.jiejue.ai| E[Web服务]
    C -->|不匹配任何配置| F[默认后端\n返回404]
    D --> G[API Pod 1]
    D --> H[API Pod 2]
    E --> I[Web Pod 1]
    E --> J[Web Pod 2]
```.

Когда запрос поступает на контроллер Ingress, он проверяет заголовок "Host" (т. е. информацию о доменном имени) в запросе и на основе этой информации направляет запрос на нужную внутреннюю службу. Если заголовок Host не предоставлен или если предоставленный заголовок Host не соответствует ни одному из настроенных правил, Ingress возвращает ошибку 404.

## Фактическое решение

Если вам нужно протестировать непосредственно IP-адрес, есть несколько способов сделать это:

### Метод 1: Используйте заголовок Host для указания целевой службы.

```bash
curl -H "Host: api.jiejue.ai" http://10.18.17.64/request
```.

Таким образом, даже имея IP-адрес, вы сообщаете Ingress, к какому сервису хотите получить доступ.

### Метод 2: Использование параметра --resolve (подмена DNS)

```bash
curl https://api.jiejue.ai/request --resolve api.jiejue.ai:443:10.18.17.64
```.

Эта команда указывает curl разрешить `api.jiejue.ai` в `10.18.17.64`, сохранив при этом правильный заголовок Host.

### Метод 3: Изменение локального файла hosts

Добавьте строку в локальный файл hosts:

```
10.18.17.64 api.jiejue.ai
```_.

После этого вы сможете обращаться к нему напрямую, используя доменное имя:

```bash
curl https://api.jiejue.ai/request
```.

## Способы обойти Ingress и получить доступ к службе напрямую

Иногда вы можете захотеть обойти Ingress и получить доступ к внутренним сервисам напрямую для тестирования. В Kubernetes для этого можно использовать команду `kubectl port-forward`:

```bash
kubectl -n 命名空间 port-forward service/服务名称 80:80
```

и затем получить доступ к ней локально:

```bash
curl http://localhost/path
```

Такой подход создает прямой канал от локального компьютера к определенному сервису в кластере Kubernetes, полностью обходя Ingress.

## Почему это было задумано именно так?

Вы можете спросить: зачем все так усложнять? Не лучше ли просто использовать IP?

Это связано с тем, что в современных архитектурах микросервисов на одном IP-адресе может быть размещено несколько различных сервисов (так называемых "виртуальных хостов"). Маршрутизация на основе домена позволяет это сделать:

1. **Эффективное использование ресурсов**: несколько сервисов используют один IP и балансировщик нагрузки
2. **Гибкие правила маршрутизации**: гибкая маршрутизация на основе путей, заголовков и т. д.
3. **Централизованное управление**: единая точка входа для управления всем трафиком

Это как телефонный коммутатор: хотя у компании есть только один номер коммутатора, в зависимости от того, какой отдел вам нужен, коммутатор будет переводить вас на разные добавочные номера.

## Резюме

Теперь вы должны понимать, почему прямой доступ к IP-адресу Kubernetes Ingress приводит к ошибке 404. Это не ошибка, это сделано специально: Ingress должен знать, к какому "виртуальному хосту" вы пытаетесь обратиться, чтобы правильно направить ваш запрос.

При разработке и тестировании учитывайте следующее:

1. используйте правильный заголовок Host или доменное имя для доступа к службе
2. если используется IP-адрес, добавьте соответствующий заголовок Host.
3. рассмотрите возможность использования __PROTECTED_INLINE_CODE__13__, если вам нужно обойти Ingress.

Надеемся, что эта статья поможет вам лучше понять механизм сетевой маршрутизации в Kubernetes, особенно тем разработчикам, которые только начинают работать с Kubernetes.

## Упражнение на размышление

Попробуйте провести следующий эксперимент в своей среде разработки: обратитесь к контроллеру Ingress, используя один и тот же путь URL, но разные заголовки Host, и понаблюдайте, сможете ли вы маршрутизировать к различным сервисам. Это поможет вам лучше понять механизм маршрутизации на основе хостов.
