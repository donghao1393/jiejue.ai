---
title: "Секреты временных каталогов: логика безопасности, скрывающаяся за /tmp и /private/tmp"
date: 2025-04-15T23:14:00+04:00
slug: "tmp-private-tmp-security"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250415231607011.webp"
tags:
  - "файловая система"
  - "поручительство"
  - "macOS"
  - "Linux"
---

Почему `/tmp` и `/private/tmp` кажутся одним и тем же каталогом в macOS, но могут по-разному обрабатываться с точки зрения контроля безопасности? Каких лучших практик следует придерживаться, когда нам нужен временный каталог для экспериментов? Эта статья раскроет технические тайны и соображения безопасности, лежащие в основе временных каталогов.

<!--more-->

При работе на компьютере нам часто требуется некое "временное" рабочее пространство, где мы можем безопасно проводить эксперименты и тесты, не опасаясь испортить остальную систему. В процессе работы мы можем столкнуться с двумя каталогами, которые выглядят одинаково, но не совсем одинаковы: `/tmp` и `/private/tmp`. Как именно они связаны между собой? Почему они устроены именно так? Какая логика безопасности скрывается за этим?

## 认识 mktemp 命令：临时工作的好帮手

Прежде чем исследовать тайны временных каталогов, давайте рассмотрим очень полезную команду: `mktemp`. Эта команда специально предназначена для создания временных файлов или каталогов и особенно полезна для скриптовых и экспериментальных сред.

Представьте, что Минг - системный администратор, которому необходимо часто тестировать новые сценарии. Он не хочет засорять свою рабочую среду тестами, но ему нужно надежное место для их проведения. Вот тут-то и пригодится `mktemp`.

```bash
# 创建临时文件
TEMP_FILE=$(mktemp)
echo "临时文件位置: $TEMP_FILE"

# 创建临时目录
TEMP_DIR=$(mktemp -d)
echo "临时目录位置: $TEMP_DIR"
```

Самое большое преимущество использования `mktemp` заключается в том, что он генерирует уникальные имена файлов и позволяет избежать конфликтов имен, что делает его идеальным для использования в сценариях. Однако важно отметить, что `mktemp` создает только временные файлы или каталоги и не очищает их автоматически. Нам нужно вручную удалять эти временные файлы, когда мы закончим работу.

## 一个完整的临时工作流程

Хорошая практика временных работ должна включать три этапа: создание, использование и очистку. Ниже приведен полный пример с рыбной раковиной:

```fish
function do_experiment
    # 1. 创建临时工作空间
    set -l temp_dir (mktemp -d)
    echo "在 $temp_dir 中进行实验"
    
    # 2. 进入临时目录并工作
    pushd $temp_dir
    
    # 你的实验代码
    # ...
    
    # 3. 完成后返回原目录
    popd
    
    # 4. 清理临时环境
    rm -rf $temp_dir
end
```

Таким образом, весь экспериментальный процесс заключен в одной функции, а временная среда автоматически создается и очищается, чтобы временные файлы не занимали место на диске.

## /tmp 与 /private/tmp 的神秘关系

Когда мы используем `mktemp`, он обычно создает файлы во временном каталоге системы, который в Unix-подобных системах обычно называется `/tmp`. Но в macOS интересно отметить, что `/tmp` на самом деле является символической ссылкой на `/private/tmp`.

```bash
$ realpath /tmp
/private/tmp
```

Что здесь происходит?

### 符号链接：方便与安全的平衡

В macOS (ранее Mac OS X) некоторые стандартные каталоги Unix (такие как `/tmp`, `/var` и `/etc`) реализованы в виде символических ссылок на соответствующие подкаталоги в каталоге `/private`. У такой конструкции есть несколько важных причин:

1. **Историческая совместимость**: macOS основана на NeXTSTEP и BSD Unix, что позволяет системе поддерживать совместимость с устаревшими Unix-приложениями и при этом организовывать файловую систему по-своему.

2. **Ясность архитектуры системы**: Централизация системных каталогов в `/private' делает структуру файловой системы более понятной и облегчает обновление и обслуживание системы.

3. **Изоляция безопасности**: эта конструкция обеспечивает уровень абстракции, который позволяет системе адаптировать внутреннюю реализацию без изменения внешнего интерфейса.

### 安全模型中的微妙差异

Хотя в повседневной жизни большинство пользователей и приложений могут без проблем получать доступ к одним и тем же файлам через `/tmp` или `/private/tmp`, в среде со строгим контролем безопасности эти два пути могут восприниматься по-разному.

Например, в некоторых инструментах безопасности или средах "песочницы" символические ссылки могут обрабатываться особым образом, проверяя не только то, что сама символическая ссылка находится в пределах разрешенного доступа, но и то, что фактическая цель, на которую она указывает, также имеет разрешенный доступ.

Этот механизм двойной проверки предотвращает потенциальные атаки обхода привилегий. Представьте, что если бы приложению разрешался доступ только к `/tmp`, но не проверялась цель символических ссылок, злоумышленник мог бы создать вредоносные символические ссылки, указывающие на важные области системы, и таким образом обойти ограничения безопасности.

## 安全工具的内部实现逻辑

Давайте посмотрим, как типичный инструмент управления доступом к файловой системе обеспечивает такую защиту. Вот упрощенный псевдокод:

```typescript
async function validatePath(requestedPath) {
  // 1. 检查请求的路径是否在允许列表中
  if (!isPathInAllowedList(requestedPath)) {
    throw new Error("访问被拒绝：路径不在允许的目录中");
  }

// 2. Если это символическая ссылка, проверьте также реальный путь, на который она указывает
  const realPath = getRealpathOfSymlink(requestedPath);
  if (!isPathInAllowedList(realPath)) {
    throw new Error("Access denied: symbolic link destination is not in an allowed directory");;
  }

return realPath;
}
```

Этот механизм двойной аутентификации гарантирует, что к каталогам, доступ к которым явно не разрешен, нельзя получить даже через символические ссылки, что обеспечивает более жесткую защиту.

## 最佳实践建议

Исходя из вышеизложенного, вот несколько рекомендаций по работе с временными файлами и каталогами:

1. **Используйте `mktemp` для создания временных файлов/каталогов**: это безопаснее, чем задавать имена временных файлов вручную, и позволяет избежать конфликтов имен.

2. **Всегда очищайте временные файлы**: явно удаляйте временные файлы в конце сценария или программы, а также используйте команду `trap`, чтобы убедиться, что они будут очищены даже в случае ошибки.

3. **Учет последствий символических ссылок для безопасности**: При работе с путями, содержащими символические ссылки, помните, что в некоторых контекстах безопасности к ним может быть особое отношение.

4. **В средах, чувствительных к безопасности**: Если вы пишете инструменты, требующие строгого контроля безопасности, подумайте о проверке как символических ссылок, так и реальных путей, на которые они указывают.

## 结语

Временные каталоги могут показаться простыми, но это не так. Начиная с использования команды `mktemp`, отношений между `/tmp` и `/private/tmp` и заканчивая более глубокими соображениями безопасности файловой системы, мы видим, как разработчики операционных систем балансируют между удобством и безопасностью.

Понимание этих, казалось бы, незначительных деталей не только помогает нам лучше использовать системные инструменты, но и углубляет наше понимание конструкторского мышления в области компьютерной безопасности. Такое глубокое понимание особенно ценно сегодня, когда цифровая безопасность приобретает все большее значение.

Как вы обычно обращаетесь с временными файлами? Замечали ли вы когда-нибудь особую обработку символических ссылок в средствах контроля безопасности? Не стесняйтесь делиться своим опытом и соображениями в разделе комментариев.