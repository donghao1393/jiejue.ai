---
title: "Остерегайтесь ловушек в официальной документации: быстрая отладка назначения ролей в Azure"
date: 2025-03-13T21:29:47+04:00
slug: "beware-of-traps-in-official-docs"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250313213145816.webp"
tags:
  - "Лазурь"
  - "облачные вычисления"
  - "устранение неисправностей"
  - "передовая практика"
---

В мире облачных сервисов официальная документация часто считается библией. Но даже самая авторитетная документация может содержать небольшие ошибки или упущения, и эти крошечные "подводные камни" могут стоить вам часов или даже дней вашего времени. Сегодня я поделюсь опытом отладки, связанным с назначением ролей в Azure, и покажу, почему иногда нужно с опаской относиться к официальной документации.

<! ---далее-->

## Сценарий проблемы

Как инженер облачной инфраструктуры, я недавно настраивал доступ к набору шифрования дисков для кластера AKS (Azure Kubernetes Service). Я строго следовал инструкциям официальной документации Microsoft для выполнения команд:

```bash
az role assignment create --role "Contributor" --assignee $aksIdentity --scope $diskEncryptionSetId
```

В итоге я получил следующую ошибку:

```
Cannot find user or service principal in graph database for '"0265f235-0740-4c69-875e-06e3113af063"'. 
If the assignee is an appId, make sure the corresponding service principal is created with 
'az ad sp create --id "0265f235-0740-4c69-875e-06e3113af063"'.
```

Проверка значений переменных показала:

```bash
$ echo $diskEncryptionSetId
/subscriptions/659eaf27-2492-41f3-abb5-68ad43690880/resourceGroups/oasis-dev/providers/Microsoft.Compute/diskEncryptionSets/oasis-des-aks-dev
$ echo $aksIdentity
"0265f235-0740-4c69-875e-06e3113af063"
```

## Коренная причина проблемы

При ближайшем рассмотрении оказывается, что значение переменной `$aksIdentity` окружено двойными кавычками. И эта переменная была получена с помощью другой команды в официальной документации:

```bash
set aksIdentity (az aks show --resource-group $myResourceGroup --name $CLUSTER_NAME --query "identity.principalId")
```.

По умолчанию Azure CLI возвращает результаты в формате JSON, поэтому значение `identity.principalId` окружено кавычками. Команда назначения роли ожидает получить обычное значение UUID без кавычек.

## Решение

Решение простое: используйте манипуляцию строками, чтобы удалить лишние кавычки:

```bash
# Fish shell中去除引号的方法
set aksIdentity (echo $aksIdentity | tr -d '"')
az role assignment create --role "Contributor" --assignee $aksIdentity --scope $diskEncryptionSetId
```.

Или более элегантный подход - указать формат вывода как TSV (Tab-Separated Values) при первоначальной выборке переменной:

```bash
set aksIdentity (az aks show --resource-group $myResourceGroup --name $CLUSTER_NAME --query "identity.principalId" -o tsv)
```

Использование параметра `-o tsv` позволяет Azure CLI возвращать необработанные значения, без форматированных кавычек или другой разметки.

## Глубокие мысли: почему возникает эта проблема?

Эта кажущаяся незначительной проблема на самом деле отражает распространенный тип проблем в сложных технологических стеках: **несовпадение портов инструментальных ссылок**.

В Azure CLI есть несоответствие между двумя командами:
- Команда __PROTECTED_INLINE_CODE__12__ по умолчанию возвращает данные в формате JSON.
- Команда `az role assignment create` ожидает получить UUID без кавычек.

Официальная документация, хотя и предоставляет правильную последовательность команд, не учитывает это несоответствие форматов, особенно когда оно проявляется в среде сценариев.

## Почему этот тип проблем так трудно обнаружить?

1. **Слепое пятно в документации**: официальная документация часто предполагает, что читатель понимает поведение инструмента по умолчанию
2. **Ограниченные сценарии тестирования**: документация может быть проверена в определенной среде, но не охватывать все среды оболочки или сценарии использования.
3. **Невидимые проблемы форматирования**: невидимые символы, такие как кавычки, пробелы, переносы строк и т. д., легко игнорируются
4. **Сообщения об ошибках не интуитивны**: сообщения об ошибках не указывают в явном виде на реальную проблему (проблема с кавычками)

## Стратегия реагирования: как избежать ловушек документации?

Вот несколько практических стратегий, которые помогут вам избежать подобных ловушек при работе с официальной документацией:

1. **Проверка значений переменных**: Всегда печатайте значения ключевых переменных и перепроверяйте их во время отладки.
   ```bash
   echo $aksIdentity | od -c  # 查看包括不可见字符在内的完整字符表示
   ```.

2. **Понимание форматов вывода инструментов**: поймите форматы вывода по умолчанию для распространенных инструментов и их характеристики
   - Azure CLI: формат JSON по умолчанию
   - AWS CLI: также формат JSON по умолчанию
   - kubectl: может быть YAML или пользовательские таблицы

3. **Явно укажите формат вывода**:
   ```bash
   # Azure CLI
   az command --query "property" -o tsv
   
   # AWS CLI
   aws command --query "property" --output text
   
   # kubectl
   kubectl get resource -o jsonpath='{.property}'
   ```.

4. **Используйте помощь ИИ**: предоставление ассистентам ИИ полных команд, сообщений об ошибках и контекста окружения позволяет быстрее обнаруживать такие тонкие проблемы

## Как повысить эффективность устранения неполадок?

По моему опыту, ключевой фактор, ускоряющий решение проблем: **Предоставление полного контекста**.

Когда я предоставил помощнику ИИ полное сообщение об ошибке, значения переменных и соответствующие команды, проблема была выявлена в течение нескольких секунд. Это было гораздо эффективнее, чем часы, которые я мог бы потратить на отладку самостоятельно.

```mermaid
graph TD
    A[发现问题] --> B[收集完整上下文]
    B --> C[准确描述问题]
    C --> D[咨询AI或同事]
    D --> E[验证解决方案]
    E --> F[记录经验教训]
    
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#f9f,stroke:#333,stroke-width:2px
```.

## Резюме и размышления

Официальная документация - это действительно бесценный ресурс для изучения и использования технологий, но мы не должны слепо доверять каждой детали в ней. Если относиться к документации как к руководству, а не как к догме, сохранять критическое мышление и правильно использовать вспомогательные инструменты (например, ИИ, экспертную оценку), можно значительно повысить эффективность решения проблем.

Сложность пространства облачных вычислений диктует, что мы никогда не сможем предугадать все возможные проблемы, но, развивая хорошие привычки отладки и открыто обращаясь за помощью, мы сможем решать проблемы с большей легкостью.

В следующий раз, когда вы будете следовать официальной документации и столкнетесь со странной ошибкой, вспомните, что документация тоже написана людьми, и в ней иногда бывают упущения. Наблюдайте, думайте, обращайтесь за помощью, когда это необходимо, и вы обнаружите, что решение часто оказывается проще, чем вы думали.

---

Приходилось ли вам сталкиваться с подобными "ловушками" официальной документации? Не стесняйтесь делиться своим опытом и способами борьбы с ними в разделе комментариев!
