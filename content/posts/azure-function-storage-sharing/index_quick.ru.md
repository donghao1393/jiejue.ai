---
title: "Практическое руководство по учетной записи Azure Function App Multi-App Shared Storage"
date: 2025-07-04T20:47:48+04:00
slug: "azure-function-storage-sharing-guide"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250704205059684.webp"
tags:
  - "Лазурь"
  - "Функциональное приложение"
  - "Счет хранения"
  - "DevOps"
  - "Оптимизация затрат"
---

Будучи разработчиком Azure или инженером DevOps, вы могли столкнуться со сценарием, в котором ваша компания имеет несколько функциональных приложений, но хочет, чтобы они использовали одну учетную запись хранения для контроля затрат или удобства управления. Возможно ли это? Каковы риски? Как правильно это настроить?

<! -еще-->

## Предыстория: зачем Function App нужен аккаунт хранения?

С самого начала необходимо прояснить один важный факт: **Для работы приложения Azure Function App должна быть настроена учетная запись хранения**, это не является опцией.

Согласно официальной документации Microsoft (обновлена в июле 2024 года), Function App использует учетную запись хранения для:
- Хранить код функции и файлы конфигурации
- управления функциональными клавишами (Function Keys)
- обрабатывать информацию о расписании для триггеров таймера
- хранения информации о состоянии различных триггеров

Основным элементом конфигурации является __PROTECTED_INLINE_CODE__5__, который указывает на общий аккаунт хранения, который должен поддерживать сервисы Blob, Queue и Table.

## Общие учетные записи хранилищ: возможно, но с осторожностью

**Хорошая новость: несколько функциональных приложений действительно могут использовать один и тот же аккаунт хранения.

Среда выполнения Azure Functions различает разные приложения с помощью механизма под названием "Host ID". Каждое функциональное приложение создает отдельный путь данных в учетной записи хранилища, подобно различным папкам:

```
azure-webjobs-hosts/
├── app1-host-id/          # Function App 1的数据
├── app2-host-id/          # Function App 2的数据
└── app3-host-id/          # Function App 3的数据
```.

## Потенциальный риск: конфликт идентификаторов хостов

**Самый большой риск - это конфликты идентификаторов хостов**. По умолчанию идентификатор хоста - это первые 32 символа имени функционального приложения. Рассмотрим следующий сценарий:

```
my-company-payment-service-prod   # Host ID: my-company-payment-service-pr
my-company-payment-service-test   # Host ID: my-company-payment-service-pr (相同!)
```.

Когда два функциональных приложения генерируют один и тот же идентификатор хоста, они записываются в один и тот же путь в учетной записи хранилища, что приводит к путанице данных, конфликтам функциональных ключей и даже ошибкам во время выполнения.

## Решение: установить уникальный идентификатор хоста

Решить эту проблему очень просто: добавьте конфигурацию в Application Settings функционального приложения:

```json
{
    "AzureFunctionsWebHost__hostid": "payment-prod-2024"
}
```_.

Эта конфигурация отменяет правила генерации Host ID по умолчанию и гарантирует, что каждое Function App использует уникальный идентификатор.

**Правила именования идентификаторов хостов: **.
- Длина: 1-32 символа
- Символы: могут содержать только строчные буквы, цифры и дефисы
- Формат: не может начинаться или заканчиваться дефисом, не может содержать последовательных дефисов

## Пример фактической конфигурации

Предположим, у вас есть три функциональных приложения, которые должны совместно использовать учетную запись хранения:

```json
// 支付服务 - 生产环境
{
    "AzureWebJobsStorage": "DefaultEndpointsProtocol=https;AccountName=mycompanystorage;AccountKey=...",
    "AzureFunctionsWebHost__hostid": "payment-prod-001",
    "WEBSITE_CONTENTSHARE": "payment-prod-share"
}

// 支付服务 - 测试环境  
{
    "AzureWebJobsStorage": "DefaultEndpointsProtocol=https;AccountName=mycompanystorage;AccountKey=...",
    "AzureFunctionsWebHost__hostid": "payment-test-001",
    "WEBSITE_CONTENTSHARE": "payment-test-share"
}

// 通知服务 - 生产环境
{
    "AzureWebJobsStorage": "DefaultEndpointsProtocol=https;AccountName=mycompanystorage;AccountKey=...",
    "AzureFunctionsWebHost__hostid": "notification-prod-001", 
    "WEBSITE_CONTENTSHARE": "notification-prod-share"
}
```.

Обратите внимание, что каждое приложение имеет:
1. **Уникальный идентификатор хоста**: во избежание конфликтов путей передачи данных
2. **Независимое разделение содержимого**: обеспечение изоляции хранилища кода

## Специальная обработка слотов развертывания

Если вы используете слоты развертывания, вам нужно обратить особое внимание: по умолчанию производственные слоты и слоты Staging будут генерировать один и тот же идентификатор хоста.

**Решение**: установите отдельный Host ID для каждого слота и отметьте его как **Deployment Setting** (он не будет заменен при замене слотов):

```json
// Production Slot
{
    "AzureFunctionsWebHost__hostid": "myapp-production"
}

// Staging Slot  
{
    "AzureFunctionsWebHost__hostid": "myapp-staging"
}
```.

## Соображения по производительности и стоимости

Несмотря на техническую возможность, Microsoft официально не рекомендует:

> "Для достижения наилучшей производительности каждое функциональное приложение должно использовать отдельную учетную запись хранения, особенно если у вас есть долговременные функции или триггеры Event Hub, поскольку они генерируют большое количество транзакций хранения".

**Когда целесообразно использовать общий доступ:**
- Среды разработки/тестирования
- Функциональное приложение с низким трафиком
- Оптимизация затрат является основным моментом

**Когда оно должно быть автономным:**
- Критически важные бизнес-приложения для производственных сред
- Приложения, использующие долговременные функции
- Приложения с высоким параллелизмом или большим количеством операций хранения

## Мониторинг и устранение неполадок

Azure Functions Runtime v4.x автоматически обнаруживает конфликты идентификаторов хостов и сообщает об ошибках. Проверьте конфигурацию идентификатора хоста, если вы столкнулись со следующими проблемами:

- Сбой запуска приложения функции
- Исключение ключа функции
- Неожиданное поведение функции
- Ошибки, связанные с хранением данных

## Резюме

Несколько функциональных приложений могут совместно использовать учетные записи хранилища, главное, чтобы это было возможно:

1. **Установите уникальный идентификатор хоста**: используйте конфигурацию `AzureFunctionsWebHost__hostid`.
2. **Индивидуальные общие ресурсы содержимого**: убедитесь, что `WEBSITE_CONTENTSHARE` отличается друг от друга.
3. **Мониторинг производительности**: следите за объемом транзакций и задержками учетных записей хранения.
4. **Осторожное использование в производстве**: оценка бизнес-рисков и требований к производительности

При правильной конфигурации можно избежать риска конфликтов и одновременно контролировать расходы, позволяя нескольким функциональным приложениям гармонично сосуществовать в одной учетной записи хранилища.

---

*Ссылка на документ: Microsoft Learn - Storage considerations for Azure Functions (обновлено в июле 2024 года)*.
