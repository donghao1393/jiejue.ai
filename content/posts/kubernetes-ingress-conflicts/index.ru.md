---
title: "Избегайте подводных камней: руководство по устранению конфликтов в конфигурации Kubernetes Ingress"
date: 2025-03-21T18:53:50+04:00
slug: "kubernetes-ingress-conflicts-troubleshooting"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250321185459888.webp"
tags:
  - "Kubernetes"
  - "ретикуляция"
  - "скрининг проблем"
  - "Проникновение"
---

Сталкивались ли вы с ситуацией, когда к сервису Kubernetes можно получить доступ через Service, но после прохождения через Ingress он возвращает 404, или все вроде бы настроено правильно, но запрос просто не может достичь целевого сервиса? В этой статье мы расскажем о распространенной, но легко упускаемой из виду проблеме настройки Kubernetes Ingress и ее решении.

<! --подробнее-->

## Загадочная проблема 404

Недавно мы столкнулись с непонятной проблемой в нашей среде Azure AKS: у нас есть служба, развернутая на кластере Kubernetes, которая обслуживается извне через стандартную архитектуру Pod-Service-Ingress-AppGW.

Изначально мы думали, что только адрес по умолчанию будет возвращать 404, но на самом деле все запросы на уровне Ingress возвращают 404, даже те, которые прекрасно работают в других средах. Как ни странно, когда мы обращались к нему напрямую через службу, все работало нормально.

## Устранение неполадок

Мы начали систематический процесс устранения неполадок:

1. сначала убедитесь, что Pod находится в нормальном состоянии и способен обрабатывать запросы
2. убедитесь, что служба правильно маршрутизирует трафик на Pod (путем тестирования внутри Pod).
3. убедитесь, что Ingress настроен правильно.
4. Попробуйте изменить правила пути Ingress и правила перезаписи.
5. просмотрите журналы контроллера Nginx и журналы приложений.

Наконец, мы нашли первопричину проблемы: **Множество ресурсов Ingress в кластере использовали одно и то же имя хоста**. Один из неиспользуемых и плохо настроенных Ingress (отсутствие надлежащей конфигурации сертификата и т. д.) конфликтовал с нашим основным Ingress, заставляя Azure Application Gateway потенциально направлять запросы в неправильный бэкэнд.

## Правила приоритета маршрутизации ингресса Kubernetes

Когда несколько объектов Ingress имеют одно и то же имя хоста, Kubernetes следует набору правил, чтобы определить, какой из Ingress обрабатывает конкретный запрос. Эти правила могут немного отличаться для разных контроллеров Ingress:

```mermaid
graph TD
    A[请求进入] --> B{检查主机名}
    B --> C[多个Ingress使用相同主机名]
    C --> D{按路径长度排序}
    D --> E[最长路径匹配具有最高优先级]
    D --> F{路径类型比较}
    F --> G[Exact > Prefix > ImplementationSpecific]
    F --> H{创建时间考虑}
    H --> I[创建时间早的Ingress优先]
    B --> J[单个Ingress使用此主机名]
    J --> K[直接路由到匹配的后端服务]
```.

### Общие правила приоритета

1. **Принцип подбора самого длинного пути**.
   - Более специфические/длинные пути имеют более высокий приоритет, чем общие/короткие пути.
   - Пример: `/foo/bar` имеет более высокий приоритет, чем `/foo`

2. **Приоритет типа пути** ***Приоритет типа пути
   - `Exact` > `Prefix` > `ImplementationSpecific`
   - Точные совпадения имеют приоритет над префиксными совпадениями

3. **Время создания**
   - При прочих равных условиях ингресс, созданный раньше, обычно имеет более высокий приоритет

### Nginx Ingress Controller specific rules

Контроллер ингресса Nginx (обычно тип nginx-internal в AKS) имеет более сложные правила:

1. **Обозначенные пользовательские приоритеты**.
   - Пользовательские приоритеты могут быть установлены с помощью аннотации `nginx.ingress.kubernetes.io/configuration-snippet`.
   - Канареечные правила и веса могут быть заданы с помощью аннотации `nginx.ingress.kubernetes.io/canary`.

2. **Алгоритмы сопоставления путей**.
   - Nginx использует правила, упорядоченные от наиболее специфичных к наименее специфичным:
     - Точное совпадение строк
     - Сопоставление префиксов, отсортированное по длине сегмента пути (сначала длинные)
     - Сопоставление регулярных выражений (в порядке определения)

### Специальные соображения для Azure Application Gateway

Когда Azure AKS использует шлюз приложений в качестве входа, на правила приоритезации влияют дополнительные факторы:

1. **Приоритет отображения путиURL**.
   - Правила пути шлюза приложений рассматриваются в порядке создания.
   - Несколько правил пути для одного и того же слушателя обрабатываются в том порядке, в котором они определены

2. **Привязка сертификата**
   - Слушатели с действительными привязками сертификатов обычно имеют более высокий приоритет

В этом случае может возникнуть ошибка, подобная этой: __PROTECTED_INLINE_CODE__9__, указывающая на то, что шлюз приложений попытался подключиться к неправильному бэкенду.

## Как обнаружить и разрешить конфликты Ingress

### Быстрое обнаружение ингресса с тем же именем хоста

Используйте следующую команду, чтобы быстро найти все ингрессы в кластере с определенным именем хоста:

```bash
kubectl get ingress --all-namespaces -o json | jq '.items[] | select(.spec.rules[].host=="your-hostname.example.com") | .metadata.name + " in namespace " + .metadata.namespace'
```.

В этой команде перечислены все ресурсы Ingress, использующие указанное имя хоста, и пространство имен, в котором они находятся.

### Лучшие практики разрешения конфликтов

1. **Не более одного Ingress на имя хоста**.
   - Самый простой и надежный способ разрешения конфликтов - убедиться, что каждое имя хоста используется только одним ресурсом Ingress.
   - Если имена хостов должны быть общими, убедитесь, что правила пути не пересекаются.

2. **Явная политика именования** **Используйте описательные имена для каждого Ingress.
   - Используйте описательные имена для каждого ингресса, которые четко указывают на его назначение и целевую службу.
   - Например: `api-public-ingress`, `frontend-internal-ingress`.

3. **Использование меток и разделение пространства имен**.
   - Изолируйте различные ресурсы Ingress с помощью пространств имен и меток.
   - Периодически просматривайте и очищайте ресурсы Ingress, которые больше не используются

4. **Мониторинг и ведение журналов
   - Контролируйте журналы контроллера Ingress для выявления конфликтов маршрутизации
   - Периодически проверяйте журналы диагностики шлюза приложений в среде Azure

## Устранение неполадок

В нашем случае решение было простым, но эффективным: после удаления неиспользуемого и плохо настроенного ресурса Ingress с тем же именем хоста все запросы стали работать немедленно.

Этот урок - напоминание о том, что **при устранении неполадок в Kubernetes важно не только проверять непосредственно связанные ресурсы, но и помнить о возможных конфликтах ресурсов, особенно с маршрутизируемыми ресурсами, такими как Ingress. **

## Резюме и рекомендации

Ingress в Kubernetes - это мост между внешним миром и службами внутри кластера, и его правильная настройка очень важна для обеспечения доступности приложений. При возникновении проблем, связанных с Ingress:

1. **Проверьте весь путь**: от запроса пользователя до ответа бода, слой за слоем.
2. **Проверьте конфигурацию ресурса**: убедитесь, что все конфигурации (пути, правила перезаписи, сертификаты TLS и т. д.) верны.
3. **Устранение конфликтов ресурсов**: особенно если несколько ингрессов используют одно и то же имя хоста.
4. **Используйте протоколирование и мониторинг**: журналы контроллера Ingress и приложений часто содержат ценные подсказки.

Надеемся, эта статья поможет вам избежать подобных ловушек при работе с конфигурациями Kubernetes Ingress. В сложных архитектурах микросервисов иногда самой сложной проблемой является не неправильная конфигурация, а неожиданные конфликты конфигураций.

**Задумайтесь над вопросом**: есть ли в вашей среде Kubernetes несколько ресурсов Ingress, использующих одно и то же имя хоста? Если да, попробуйте проверить их с помощью команд, приведенных в этой статье, и, возможно, обнаружите потенциальные проблемы с маршрутизацией.
