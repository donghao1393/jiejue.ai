---
title: "Улучшения в tmuxf: Улучшения в сохранении и восстановлении рабочего стола tmux"
date: 2025-02-01T21:30:04+04:00
slug: "tmuxf-capture-commands"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250201213744907.webp"
tags:
  - "рыбья раковина"
  - "tmux"
  - "рабочий процесс"
---

Несколько месяцев назад я написал статью "Make Fish Shell easily manage your tmux environment" для сохранения и восстановления рабочего стола tmux. Однако при реальном использовании я обнаружил некоторые проблемы, в основном связанные с отсутствием функции захвата и восстановления команд. Например, некоторые долго выполняющиеся команды (например, hugo server) сохранялись некорректно, а некоторые специальные команды мониторинга (например, btm) обрабатывались непоследовательно. В этой статье описаны технические трудности и решения, с которыми пришлось столкнуться в процессе доработки.

<! --подробнее-->

## Возникшие проблемы

### 1. Неполный захват команды

В первоначальном проекте мы использовали строку формата `#{pane_current_command}` в tmux для получения команд, выполняющихся в панели. Однако с этим подходом есть несколько проблем:

1. вы можете получить только первую часть команды (двоичное имя), а не полные аргументы командной строки
2. для команд, запущенных в оболочке, вместо фактической команды возвращается имя оболочки (например, fish)

Пример: для такой команды, как `hugo server -D --bind 0.0.0.0 --baseURL ...`, можно получить только `hugo`.

### 2. Обработка специальных процессов

Некоторые команды (например, системный монитор btm) полностью заменяют текущий процесс оболочки, что является особым случаем:

1. они не оставляют видимого текста команды после командной строки
2. они отображаются как имена процессов, а не как полные команды
3. первоначально они обрабатывались как прямой аргумент tmux new-session, что приводило к непоследовательному поведению

### 3. Идентификация и сопоставление команд

При попытке перехвата команд мы столкнулись с несколькими техническими трудностями:

1. индексация панелей: tmux использует индексацию на основе 0, а массив fish - на основе 1. 2. сопоставление командных строк: необходимость работы с пробелами и кавычками в командах.
2. сопоставление командных строк: необходимость работы с пробелами, специальными символами и кавычками в командах.
3. Различие между одноразовыми и постоянно выполняющимися командами: команды типа `tmuxf save` не должны сохраняться.

## Решение

### 1. полный перехват команд

Мы разработали более сложную стратегию перехвата команд:

```fish
# 使用 capture-pane 获取面板内容
set -l cmd (tmux capture-pane -t "$session:$window.$pane_idx" -p -S - | rg '^\$ ' | tail -1 | string replace -r '^\$ ' '')
```.

Этот метод:

1. используйте `capture-pane`, чтобы получить всю историю панели.
2. сопоставьте командную строку с `rg '^\$ '`.
3. получите последнюю команду с помощью `tail -1`.
4. очистите раздел командной строки

### 2. Улучшения в подборе команд

Для правильной идентификации и сопоставления команд мы использовали более точные регулярные выражения:

```fish
# 如果命令以当前进程名开始，直接使用完整命令行
if string match -r "^$current_cmd\s+.*" $cmd
    set cmd (string match -r "^($current_cmd\s+.*)$" $cmd)[1]
else if string match -r ".*(\s|^)$current_cmd(\s|\$).*" $cmd
    set cmd (string match -r ".*?(\s|^)($current_cmd\s+[^\$]*)$" $cmd)[2]
end
```.

Это логика сопоставления:

1. предпочтительно подбирает полные команды, начинающиеся с имени процесса
2. если это не так, пытается найти имя процесса в команде и извлечь соответствующие части
3. обрабатывает специальные символы и кавычки в команде.

### 3. Унифицированное выполнение команды

Для единообразия мы унифицировали способ выполнения команд:

```fish
# 创建会话/窗口时只指定路径
echo "tmux new-session -d -s '$name' -c '$first_path'" >> $config_file

# 通过 send-keys 执行命令
if test -n "$first_cmd"
    echo "tmux send-keys -t '$name:0.0' '$first_cmd' C-m" >> $config_file
end
```.

Такие улучшения гарантируют, что:

1. все команды выполняются в среде оболочки
2. специальные команды обрабатываются так же, как и обычные команды
3. команды выполняются в среде, которая больше похожа на ту, которую пользователь выполнял бы вручную

### 4. поддержка отладки

В процессе разработки мы добавили подробный отладочный вывод:

```fish
echo "Debug: pane_commands=$pane_commands, pane_idx=$pane_idx" >&2
echo "Debug: current_cmd=$current_cmd" >&2
echo "Debug: original cmd=$cmd" >&2
echo "Debug: cleaned cmd=$cmd" >&2
```.

Эти выводы помогают нам:

1. проследить процесс захвата команды
2. диагностировать проблемы согласования
3. проверить очистку команд

## Краткое изложение технических моментов

Это улучшение охватывает ряд технических моментов программирования оболочки:

1. **управление сеансами tmux**

   - Использование `capture-pane` для получения содержимого панели
   - Работа с системой индексации tmux (на основе 0)
   - Корректная работа со средой выполнения команд
2. **Особенности оболочкиfish shell

   - Работа с индексацией массивов (на основе 1)
   - Работа со строками и их замена
   - Сопоставление регулярных выражений
3. **Управление процессами

   - Различение непрерывной работы и одноразовых команд
   - Работа со специальными процессами (например, btm)
   - Поддержание согласованности в среде выполнения
4. **Обработка строк**

   - Разбор аргументов командной строки
   - Экранирование специальных символов
   - Оптимизация регулярных выражений

## Направления для последующих улучшений

1. **Поддержка конфигурации**

   - Позволяет пользователям настраивать список специальных команд
   - Поддержка пользовательских правил перехвата команд
2. **Увеличение надежности**

   - Добавьте дополнительные возможности обработки ошибок
   - Улучшение механизма проверки команд
3. **Расширение функциональности

   - Поддержка сохранения более сложных макетов окон
   - Добавить функцию шаблона рабочего стола

Это усовершенствование не только решает проблемы практического использования, но и углубляет понимание tmux и fish shell. Надеюсь, эти улучшения помогут другим разработчикам tmux сделать управление верстаком более удобным и надежным.
