---
title: "Улучшение tmuxf: Улучшение сохранения и восстановления рабочего стола tmux"
date: 2025-02-01T21:30:04+04:00
slug: "tmuxf-capture-commands"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250201213744907.webp"
tags:
  - "рыбья раковина"
  - "tmux"
  - "рабочий процесс"
---

Несколько месяцев назад я написал статью "Make Fish Shell easily manage your tmux environment" для сохранения и восстановления рабочего стола tmux. Однако при реальном использовании я обнаружил некоторые проблемы, в основном связанные с отсутствием функции захвата и восстановления команд. Например, некоторые долго выполняющиеся команды (например, hugo server) сохранялись некорректно, а некоторые специальные команды мониторинга (например, btm) обрабатывались непоследовательно. В этой статье описаны технические трудности и решения, с которыми пришлось столкнуться в процессе доработки.

<!--more-->

## 遇到的问题

### 1. 命令捕获不完整

В первоначальном варианте мы использовали строку формата tmux `#{pane_current_command}` для получения текущей команды, запущенной в панели. Однако с этим подходом есть несколько проблем:

1. можно получить только первую часть команды (двоичное имя), а не все аргументы командной строки.
2. для команд, запущенных в оболочке, вместо фактической команды возвращается имя оболочки (например, fish).

Пример: Для команды `hugo server -D --bind 0.0.0.0 --baseURL ... `, вы можете получить только `hugo`.

### 2. 特殊进程的处理

Некоторые команды (например, инструмент системного мониторинга btm) полностью заменяют текущий процесс оболочки, и у этих команд есть свои особенности:

1. не оставляет видимого текста команды после командной строки
2. отображается непосредственно имя процесса вместо полной команды
3. первоначально обрабатывался как прямой аргумент tmux new-session, что приводило к непоследовательному поведению

### 3. 命令标识和匹配

При попытке захвата команд мы столкнулись с несколькими техническими трудностями:

1. Индексация панелей: tmux использует индексацию на основе 0, в то время как массивы fish - на основе 1.
2. сопоставление командных строк: необходимо учитывать пробелы, специальные символы и кавычки в командах
3. одноразовые и постоянные команды: команды типа `tmuxf save` не должны сохраняться.

## 解决方案

### 1. 完整命令捕获

Мы разработали более сложную стратегию захвата команд:

```fish
# 使用 capture-pane 获取面板内容
set -l cmd (tmux capture-pane -t "$session:$window.$pane_idx" -p -S - | rg '^\$ ' | tail -1 | string replace -r '^\$ ' '')
```

Этот метод:

1. используйте `capture-pane`, чтобы получить всю историю панели
2. сопоставьте командные подсказки с `rg '^\$ '`.
3. используйте `tail -1`, чтобы получить последнюю команду.
4. очистите раздел командной строки

### 2. 命令匹配改进

Чтобы правильно определить и сопоставить команды, мы используем более точные регулярные выражения:

```fish
# 如果命令以当前进程名开始，直接使用完整命令行
if string match -r "^$current_cmd\s+.*" $cmd
    set cmd (string match -r "^($current_cmd\s+.*)$" $cmd)[1]
else if string match -r ".*(\s|^)$current_cmd(\s|\$).*" $cmd
    set cmd (string match -r ".*?(\s|^)($current_cmd\s+[^\$]*)$" $cmd)[2]
end
```

Это логика соответствия:

1. установите приоритет совпадений с командами, которые начинаются с имени процесса
2. если нет, попытайтесь найти имя процесса в команде и извлечь соответствующую часть
3. обработка специальных символов и кавычек в командах

### 3. 统一的命令执行方式

Для единообразия мы стандартизировали выполнение команды:

```fish
# 创建会话/窗口时只指定路径
echo "tmux new-session -d -s '$name' -c '$first_path'" >> $config_file

# 通过 send-keys 执行命令
if test -n "$first_cmd"
    echo "tmux send-keys -t '$name:0.0' '$first_cmd' C-m" >> $config_file
end
```

Такие усовершенствования обеспечивают:

1. все команды выполняются в среде shell
2. специальные команды обрабатываются так же, как и обычные.
3. команды выполняются в среде, приближенной к той, которую пользователь выполнял бы вручную.

### 4. 调试支持

В процессе разработки мы добавили подробную отладочную информацию:

```fish
echo "Debug: pane_commands=$pane_commands, pane_idx=$pane_idx" >&2
echo "Debug: current_cmd=$current_cmd" >&2
echo "Debug: original cmd=$cmd" >&2
echo "Debug: cleaned cmd=$cmd" >&2
```

Эти результаты помогают нам:

1. отслеживание процесса захвата команды
2. диагностика проблем с согласованием
3. проверка очистки команд

## 技术要点总结

Это усовершенствование охватывает несколько технических моментов программирования в оболочке:

1. **управление сеансами tmux**.

- Использование `capture-pane` для получения содержимого панели
   - Работа с системой индексации tmux (на основе 0)
   - Корректная работа со средой выполнения команд
2. ** Особенности оболочкиfish

- Работа с индексами массивов (на основе 1)
   - Работа со строками и их замена
   - Согласование регулярных выражений
3. **Управление процессами**

- Различайте непрерывное выполнение и одноразовые команды
   - Работа со специальными процессами (например, btm)
   - Поддержание согласованности в среде выполнения
4. **Обработка строк**

- Разбор параметров командной строки
   - Исключение специальных символов
   - Оптимизация регулярных выражений

## 后续改进方向

1. **Поддержка конфигурации**.

- Разрешить определяемый пользователем список специальных команд
   - Поддержка пользовательских правил захвата команд
2. **Увеличение надежности**

- Добавьте больше обработки ошибок
   - Улучшить механизм проверки команд
3. **Функциональные расширения**

- Поддержка сохранения более сложных макетов окон
   - Добавить функцию шаблона рабочего стола

Это улучшение не только решает проблему в практическом использовании, но и углубляет понимание tmux и fish shell. Надеюсь, эти улучшения помогут другим разработчикам tmux сделать управление верстаком проще и надежнее.