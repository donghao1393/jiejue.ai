---
title: "Устранение неполадок при сбросе соединений в средах частной сети шлюза приложений Azure: критическая роль параметров SNI"
date: 2025-03-18T20:59:56+04:00
slug: "solving-connection-reset-with-sni-in-azure-application-gateway"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250318210156389.webp"
tags:
  - "Лазурь"
  - "ретикуляция"
  - "шлюз приложений"
  - "устранение неисправностей"
---

При переносе Azure Application Gateway из общедоступной сети в частную среду, даже если конфигурация кажется правильной, вы можете неожиданно столкнуться с проблемой сброса TLS-соединений. В этой статье мы расскажем о простой на первый взгляд, но часто упускаемой из виду ключевой настройке: параметре SNI (Server Name Indication) и о том, как с его помощью можно решить проблемы со сбросом соединений.

<! --подробнее-->

## Сценарии проблем

Недавно нам понадобилось перенести службу, развернутую на Azure Application Gateway, с публичного IP на частный IP, чтобы соответствовать требованиям безопасности. Процесс миграции кажется простым: измените `frontend_ip` с `appGwPublicIpv4` на `appGwPrivateIpv4` в конфигурации Terraform.

Однако после применения конфигурации при попытке доступа к сервису по-прежнему возникает следующая ошибка, даже если файл hosts правильно изменен для разрешения DNS:

```
$ curl https://example.jiejue.ai/v1/chat/completions -v --resolve example.jiejue.ai:443:10.23.4.5
* Added example.jiejue.ai:443:10.23.4.5 to DNS cache
* Hostname example.jiejue.ai was found in DNS cache
*   Trying 10.23.4.5:443...
* Connected to example.jiejue.ai (10.23.4.5) port 443
* ALPN: curl offers h2,http/1.1
* (304) (OUT), TLS handshake, Client hello (1):
*  CAfile: /etc/ssl/cert.pem
*  CApath: none
* Recv failure: Connection reset by peer
* LibreSSL/3.3.6: error:02FFF036:system library:func(4095):Connection reset by peer
* Closing connection
curl: (35) Recv failure: Connection reset by peer
```.

При тестировании базового подключения с помощью telnet все в порядке:

```
$ telnet 10.23.4.5 443
Trying 10.23.4.5...
Connected to example.jiejue.ai.
Escape character is '^]'.
Connection closed by foreign host.
```.

Это означает, что базовое сетевое соединение работает, но что-то не так на этапе рукопожатия TLS.

## Решение: Включить SNI

После устранения неполадок мы обнаружили, что добавление простой строки конфигурации решило проблему:

```hcl
require_sni = true
```.

Этот параметр необходимо добавить в конфигурацию HTTPS-приемника. Полные различия в конфигурации Terraform выглядят следующим образом:

```diff
listener = {
  frontend_ip   = "appGwPrivateIpv4"
  frontend_port = 443
  protocol      = "Https"
+ require_sni   = true
}
```

После добавления этой строки служба немедленно возобновит нормальный доступ.

## Почему это происходит и что такое SNI?

SNI (Server Name Indication) - это расширение протокола TLS, которое позволяет клиенту указывать имя хоста, с которым он хочет соединиться, на ранней стадии процесса рукопожатия SSL/TLS. Это позволяет серверу предоставлять услуги HTTPS для нескольких различных доменов на одном IP-адресе, каждый из которых использует свой SSL-сертификат.

### Как работает SNI

Процесс работы SNI выглядит следующим образом:

1. клиент инициирует HTTPS-соединение и включает расширение SNI в сообщение ClientHello в процессе рукопожатия TLS, указывая имя целевого хоста.
2. сервер выбирает нужный SSL-сертификат на основе имени хоста.
3. сервер завершает рукопожатие TLS, используя выбранный сертификат.

```mermaid
flowchart TD
    subgraph "客户端"
        Client[用户浏览器]
    end

    subgraph "Azure应用网关"
        AppGW[应用网关]
        subgraph "Listener配置"
            PublicIP[公网IP监听器]
            PrivateIP[私网IP监听器]
        end
        subgraph "TLS处理"
            SNI["SNI处理<br>(Server Name Indication)"]
            Cert1["证书1<br>example.jiejue.ai"]
            Cert2["证书2<br>jiejue.ai"]
        end
    end

    subgraph "后端服务"
        Backend1[后端服务1]
        Backend2[后端服务2]
    end

    Client -->|1.HTTPS请求<br>包含SNI信息| AppGW
    AppGW --> PublicIP
    AppGW --> PrivateIP
    PublicIP -->|2a. 公网IP<br>访问| SNI
    PrivateIP -->|2b. 私网IP<br>访问| SNI
    SNI -->|3a. 匹配主机名| Cert1
    SNI -->|3b. 匹配主机名| Cert2
    Cert1 -->|4a. 使用证书1| Backend1
    Cert2 -->|4b. 使用证书2| Backend2
```_.

## Различия в поведении SNI между публичными и частными IP-адресами

Интересно, что мы обнаружили различия в том, как Application Gateway обрабатывает SNI в средах публичных и частных IP:

```mermaid
flowchart TD
    subgraph "公网IP配置<br>require_sni = false"
        C1[客户端] -->|1.请求到公网IP| PG[应用网关<br>公网IP前端]
        PG -->|2.TLS握手<br>没有SNI也能工作| PH["主机检查<br>(宽松)"]
        PH -->|3.选择默认证书| PB[后端服务]
    end

    subgraph "私网IP配置<br>require_sni = false"
        C2[客户端] -->|1.请求到私网IP| VG[应用网关<br>私网IP前端]
        VG -->|2.TLS握手<br>没有SNI信息| VH["主机检查<br>(严格)"]
        VH -->|3.无法确定证书<br>连接重置!| VB[后端服务]
    end

    subgraph "私网IP配置<br>require_sni = true"
        C3[客户端] -->|1.请求到私网IP<br>包含主机名| SG[应用网关<br>私网IP前端]
        SG -->|2.TLS握手<br>使用SNI信息| SH["主机检查<br>(严格)"]
        SH -->|3.正确匹配证书| SB[后端服务]
    end
```.

- **Общая IP-среда**: даже если клиент не предоставляет информацию SNI (например, прямой доступ по IP), Application Gateway может выбрать сертификат "по умолчанию" для завершения рукопожатия TLS.
- **Частная IP-среда**: если клиент не предоставит информацию SNI, шлюз приложений напрямую сбросит соединение, что приведет к сбою в рукопожатии TLS.

Это различие может быть связано с внутренней реализацией Azure или политикой безопасности, но такое поведение не указано в официальной документации Microsoft.

## Дополнительные сведения о параметрах SNI

В конфигурации Terraform для Azure Application Gateway параметр `require_sni` определен следующим образом:

```
require_sni - (Optional) Should Server Name Indication be Required? Defaults to false.
```

Хотя официально этот параметр описывается как необязательный и по умолчанию принимает значение `false`, на самом деле он необходим в частных сетевых средах, особенно в следующих случаях:

1. несколько сайтов используют один и тот же шлюз приложений
2. используется протокол HTTPS
3. внешний IP-адрес настроен как частный IP-адрес

## Предложения по устранению неполадок

Если вы столкнулись с подобными проблемами сброса соединения в среде частной сети Azure Application Gateway, попробуйте выполнить следующие шаги по устранению неполадок:

1. проверьте базовое соединение (с помощью такого инструмента, как telnet).
2. убедитесь, что сертификаты настроены правильно
3. **Проверьте настройки SNI**, чтобы убедиться, что для HTTPS-приемника установлено значение `require_sni = true`.
4. убедитесь, что запрос клиента содержит правильное имя хоста (а не просто IP)

## Почему Azure Portal справляется с этим автоматически?

Интересно, что если вы вручную переключите внешний IP-адрес шлюза приложений с публичного на частный в Azure Portal, Portal автоматически включит требование SNI. Это говорит о том, что Microsoft знает об этой поведенческой разнице и разумно обрабатывает ее в операциях пользовательского интерфейса.

Однако при использовании инструмента IaC, такого как Terraform, такой автоматической настройки не происходит, и конфигурацию `require_sni = true` необходимо добавлять вручную.

## Рекомендации по лучшей практике

Основываясь на нашем опыте, мы рекомендуем следующие лучшие практики:

1. **Всегда включайте SNI**: установите `require_sni = true` как для публичных, так и для частных сетевых сред.
2. **Используйте доступ по доменному имени**: убедитесь, что клиенты получают доступ к сервису напрямую через доменное имя, а не через IP
3. **Конфигурировать явно в IaC**: задавать параметры SNI явно в коде, например в Terraform
4. **Документированные требования к конфигурации**: укажите эту критическую конфигурацию в проектной документации.

## Более глубокое понимание: архитектура SNI для шлюза приложений

Для читателей, желающих погрузиться в технические подробности, приведем архитектурную схему обработки SNI в Azure Application Gateway:

{{< svg "content/posts/azure-appgw-sni/sni-architecture.svg" >}}.

Конфигурация SNI влияет на весь процесс рукопожатия TLS, особенно в многосайтовых средах. При использовании `require_sni = true` шлюз приложений строго требует от клиента информацию об имени хоста, что не только повышает безопасность, но и обеспечивает правильный выбор сертификата и маршрутизацию запросов.

## Заключение

Параметр SNI играет ключевую роль в конфигурации частной сети Azure Application Gateway, причем не только как дополнительное улучшение безопасности, но и как необходимая конфигурация для обеспечения правильной работы службы. Понимание этой тонкой разницы между публичной и частной сетевыми средами поможет вам избежать лишнего времени на устранение неполадок и разработать более надежную облачную архитектуру.

Наконец, этот случай служит напоминанием о том, что даже самые простые параметры конфигурации могут оказывать значительное влияние на доступность службы, и что необходимо уделять особое внимание этим "стандартным", но критически важным элементам конфигурации, особенно во время миграции или изменения среды.

Сталкивались ли вы с подобными проблемами конфигурации облачных сервисов? Не стесняйтесь поделиться своим опытом в разделе комментариев!
