---
title: "Подробное описание проблем блокировки состояния Terraform Azure: разрешения, разблокировка и лучшие практики"
date: 2025-06-25T21:13:41+04:00
slug: "terraform-azure-state-lock-troubleshooting"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250625211704888.webp"
tags:
  - "Terraform"
  - "Лазурь"
  - "DevOps"
  - "Управление состоянием"
  - "устранение неисправностей"
---

Когда вы используете Terraform для управления ресурсами Azure в производственной среде, вы можете столкнуться с этой непонятной ошибкой __PROTECTED_INLINE_CODE__9__. За этой, казалось бы, простой ошибкой разрешения на самом деле скрывается управление состоянием Terraform, разрешения на хранение Azure и основная философия проектирования инфраструктуры как кода.

<! -еще-->

## Повторное рассмотрение сценария проблемы

Представьте себе сценарий, в котором вы выполняете обновление конфигурации учетной записи хранилища в производственной среде, а приложение Terraform внезапно прерывается на полпути выполнения, и при попытке запустить его снова вы сталкиваетесь с ошибкой разрешения 403. Что еще больше запутывает, так это то, что несколько минут назад вы могли получить к нему нормальный доступ, так почему же теперь у вас нет никаких разрешений?

```bash
terraform plan
╷
│ Error: error loading state: blobs.Client#Get: Failure responding to request: 
│ StatusCode=403 -- Original Error: autorest/azure: Service returned an error. 
│ Status=403 Code="AuthorizationFailure" Message="This request is not authorized 
│ to perform this operation.\nRequestId:8f2e1a45-cd89-4b12-9876-3f4d5e6a7b8c\nTime:2025-06-25T14:23:17.8542156Z"
```_.

Обычно это происходит при изменении сетевого правила или конфигурации шифрования для учетной записи хранилища, файл состояния Terraform заблокирован, а проверка разрешений во время изменения не выполняется.

## Понимание двух моделей разрешений для хранилищ Azure

Прежде чем мы перейдем к решению, нам нужно понять два режима доступа для учетных записей хранилищ Azure, что является ключом к решению проблемы.

### Режим 1: аутентификация Azure AD (рекомендуемое корпоративное решение)

Стандартной практикой в современных облачных инфраструктурах является управление доступом через аутентификацию Azure AD:

```hcl
terraform {
  backend "azurerm" {
    resource_group_name  = "myapp-prod-rg"
    storage_account_name = "myappprodst01"
    container_name       = "tfstate"
    key                  = "terraform.tfstate"
    use_azuread_auth     = true  # 关键配置
  }
}
```.

Преимуществами этой модели являются:
- Унифицированное управление идентификацией с интеграцией корпоративной AD
- Более детальный контроль привилегий
- Соответствие модели безопасности с нулевым доверием
- Облегчает аудит и управление соответствием нормативным требованиям

### Режим 2: аутентификация с использованием хранимых учетных ключей

Традиционный метод проверки подлинности ключа напрямую использует ключ доступа к учетной записи хранилища:

```hcl
terraform {
  backend "azurerm" {
    resource_group_name  = "myapp-prod-rg"
    storage_account_name = "myappprodst01"
    container_name       = "tfstate"
    key                  = "terraform.tfstate"
    access_key           = "storage-account-access-key"
  }
}
```.

## Коренная причина проблем с блокировкой состояния

Механизм блокировки состояния в Terraform предназначен для защиты целостности состояния инфраструктуры. Блокировка гарантирует, что при одновременном выполнении нескольких операций:

1. **Атомарные операции**: предотвращает повреждение состояния в результате одновременных модификаций
2. **Согласованность данных**: гарантирует, что каждая операция применения будет основана на последнем состоянии
3. **Защита безопасности**: защита файла состояния в случае отключения сети или завершения операции.

Однако при изменении сетевых правил учетной записи хранения Azure в процессе применения может возникнуть проблема "курицы и яйца":
- Terraform необходимо получить доступ к учетной записи хранилища, чтобы прочитать файл состояния.
- Terraform необходимо получить доступ к учетной записи хранилища для чтения файла состояния, но изменение сетевых правил учетной записи хранилища может временно запретить этот доступ.
- Файл состояния заблокирован, и нет возможности завершить операцию или снять блокировку.

## Два набора команд разблокировки: для разных сценариев использования привилегий.

В зависимости от сценария привилегий и конфигурации среды существует два способа разблокировки:

### Сценарий 1: разблокировка с помощью разрешений Azure AD

Если у вас достаточно разрешений Azure AD:

```bash
# 首先确认当前登录状态
az account show

# 检查对存储账户的权限
az role assignment list --assignee john.doe@contoso.com \
  --scope "/subscriptions/12345678-90ab-cdef-1234-567890abcdef/resourceGroups/myapp-prod-rg/providers/Microsoft.Storage/storageAccounts/myappprodst01"

# 检查状态文件的lease状态（AD模式）
az storage blob show \
  --container-name tfstate \
  --name terraform.tfstate \
  --account-name myappprodst01 \
  --auth-mode login \
  --query 'properties.lease' \
  --output json

# 强制解锁（需要知道lock ID）
terraform force-unlock LOCK_ID

# 如果不知道lock ID，可以尝试重新初始化
terraform init -reconfigure
```

### Вариант 2: Разблокировка с помощью ключа учетной записи хранилища

Когда привилегий AD недостаточно, но можно получить ключ хранилища:

```bash
# 获取存储账户密钥
az storage account keys list \
  --resource-group myapp-prod-rg \
  --account-name myappprodst01

# 检查状态文件的lease状态（密钥模式）
az storage blob show \
  --container-name tfstate \
  --name terraform.tfstate \
  --account-name myappprodst01 \
  --account-key "storage-account-access-key" \
  --query 'properties.lease' \
  --output json

# 使用密钥配置临时访问
export ARM_ACCESS_KEY="storage-account-access-key"

# 或者修改backend配置，临时使用密钥模式
terraform init -backend-config="access_key=storage-account-access-key"

# 解锁状态
terraform force-unlock LOCK_ID
```

### Особый случай: разблокировка в условиях сетевых ограничений

Если учетная запись хранилища настроена с сетевыми ограничениями, может потребоваться временная настройка:

```bash
# 临时允许当前IP访问（需要Contributor权限）
az storage account network-rule add \
  --resource-group myapp-prod-rg \
  --account-name myappprodst01 \
  --ip-address $(curl -s ifconfig.me)

# 执行解锁操作
terraform force-unlock LOCK_ID

# 恢复网络限制（在解锁完成后）
az storage account network-rule remove \
  --resource-group myapp-prod-rg \
  --account-name myappprodst01 \
  --ip-address $(curl -s ifconfig.me)
```

## Загрузка файлов с помощью tfvars: философия дизайна для обеспечения целостности

Во время наших обсуждений мы обнаружили, что многие команды также загружают файлы tfvars в удаленное хранилище. Это не лишняя операция, а хорошо продуманный дизайн:

### Зачем загружать tfvars?

1. **Согласованность конфигурации**: убедитесь, что все члены команды и конвейер CI/CD используют одинаковые конфигурации переменных.
2. **Целостность состояния**: переменные являются важной частью состояния инфраструктуры и должны управляться вместе с файлом состояния
3. **Контроль версий**: обеспечение отслеживания и отката изменений конфигурации
4. **Соответствие требованиям**: в корпоративной среде управление конфигурацией часто требует наличия аудиторского следа

### Реализация лучших практик

```bash
# 上传tfvars到存储账户
az storage blob upload \
  --account-name myappprodst01 \
  --container-name tfstate \
  --name terraform.tfvars \
  --file terraform.tfvars \
  --auth-mode login

# 在apply前下载最新配置
az storage blob download \
  --account-name myappprodst01 \
  --container-name tfstate \
  --name terraform.tfvars \
  --file terraform.tfvars \
  --auth-mode login

# 执行计划和应用
terraform plan -var-file=terraform.tfvars
terraform apply -var-file=terraform.tfvars
```.

## Политики разрешений для различных сред

На практике для разных сред и ролей требуются разные политики разрешений:

### Среда разработки
- Разработчик: разрешения Azure AD + контрибьютор данных Storage Blob
- Хорошо подходит для обучения и экспериментов с относительно свободными разрешениями

### Производственная среда
- CI/CD-система: управляемая идентификация + принцип наименьших привилегий
- Ops: привилегии Azure AD, но могут потребоваться ключи в качестве запасного варианта
- Контейнеры/поды: блокируются управляемой идентификацией, прямого воздействия ключей нет

### Сценарии на случай непредвиденных обстоятельств
- Когда служба AD выходит из строя, хранение ключей становится важным резервным решением.
- В изолированных сетевых средах может потребоваться аутентификация с помощью ключей

### Профилактические меры и мониторинг

Чтобы избежать повторения подобных проблем, рекомендуется принять следующие меры:

### 1. Мониторинг и оповещение
```bash
# 设置存储账户访问监控
az monitor metrics alert create \
  --name "TerraformStateAccessFailure" \
  --resource-group myapp-prod-rg \
  --scopes "/subscriptions/12345678-90ab-cdef-1234-567890abcdef/resourceGroups/myapp-prod-rg/providers/Microsoft.Storage/storageAccounts/myappprodst01" \
  --condition "count 'Availability' < 100"
```.

### 2. автоматическое резервное копирование
```bash
# 定期备份状态文件
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
az storage blob copy start \
  --source-container tfstate \
  --source-blob terraform.tfstate \
  --destination-container tfstate-backup \
  --destination-blob "terraform.tfstate.$DATE" \
  --account-name myappprodst01
```

### 3. Аудит привилегий
Права доступа регулярно проверяются и аудируются для обеспечения соблюдения принципа наименьших привилегий.

## Резюме

Интеграция Terraform с Azure, несмотря на свои возможности, ставит сложные задачи управления привилегиями. Понимание модели двойной аутентификации в хранилищах Azure, владение методами разблокировки в различных сценариях и осознание важности управления tfvars - все это основные навыки, которыми должен овладеть современный специалист DevOps.

Помните, что управление состоянием - это не просто технический вопрос, это основа командной работы и корпоративного управления. В следующий раз, когда вы столкнетесь с подобной ошибкой 403, не просто ищите быстрое решение, а подумайте о модели разрешений, политике безопасности и процессах совместной работы команды, которые стоят за этим.

Способность глубоко мыслить и решать проблемы системно - вот что отличает хороших DevOps-инженеров от обычных операторов.
