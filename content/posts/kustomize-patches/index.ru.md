---
title: "Kustomize Patch Operations Explained: пример управления конфигурацией K8s"
date: 2025-02-08T19:01:43+04:00
slug: "kustomize-patches-guide"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250208190510206.webp"
tags:
  - "Kubernetes"
  - "DevOps"
  - "управление конфигурацией"
  - "Кастомизация"
---

При управлении конфигурациями Kubernetes нам часто приходится настраивать конфигурацию для различных сред. Например, тестовая среда может требовать иных параметров, чем производственная, или определенные функции могут быть включены только в определенных средах. Именно здесь пригодится функция патчей Kustomize.

<! ---далее-->

## Что такое патчи Kustomize

Патчи Kustomize - это декларативные изменения конфигурации, которые позволяют нам вносить пользовательские изменения в ресурсы Kubernetes без непосредственной модификации исходного YAML-файла. Этот подход особенно хорошо подходит для управления развертываниями в нескольких окружениях, поскольку он позволяет нам сохранять единую базовую конфигурацию, удовлетворяя при этом специфические потребности различных окружений.

## Общие типы операций для патчей

Давайте рассмотрим реальный пример, чтобы понять некоторые из основных типов операций для патчей Kustomize:

### 1. replace: Заменяет существующую конфигурацию.

Операция `replace` используется для замены значений, которые уже существуют в конфигурации. Это особенно полезно при обновлении конфигураций, специфичных для среды, например, при изменении URL-адресов служб или переменных окружения:

```yaml
patches:
  - target:
      kind: ConfigMap
      name: batch-configmap
    patch: |
      - op: replace
        path: /data/KEY_VAULT_URL
        value: https://example-keyvault.vault.azure.net/
```

В этом примере мы заменяем значение KEY_VAULT_URL в карте конфигурации. Операция `replace` требует, чтобы путь назначения уже существовал, иначе будет выдана ошибка.

### 2. операция add: добавление новой конфигурации

Операция `add` используется для добавления нового элемента конфигурации к ресурсу. Это полезно, когда необходимо добавить дополнительную функциональность в конкретную среду:

```yaml
patches:
  - target:
      kind: Deployment
      name: batch-processing
    patch: |
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: secrets-store-inline
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
```

В этом примере показано, как добавить новую конфигурацию тома в развертывание. Операция `add` добавляет новый элемент в любой правильный путь JSON.

### 3. операция remove: удаление конфигурации

Операция `remove` используется для удаления ненужных элементов конфигурации:

```yaml
patches:
  - target:
      kind: Deployment
      name: batch-processing
    patch: |
      - op: remove
        path: /spec/template/spec/volumes/0
```

Это действие удаляет элемент конфигурации для указанного пути. При использовании `remove` убедитесь, что путь назначения существует, иначе будет выдано сообщение об ошибке.

## Расширенное использование патчей

### 1. Условные патчи

Иногда нам нужно применить патчи, основанные на определенных условиях. Это можно сделать с помощью селектора цели:

```yaml
patches:
  - target:
      kind: Deployment
      labelSelector: "environment=production"
    patch: |
      - op: add
        path: /spec/replicas
        value: 3
```.

### 2. Операции с массивами

При работе с элементами массива можно использовать специальный синтаксис:

```yaml
patches:
  - target:
      kind: Deployment
      name: batch-processing
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: NEW_ENV
          value: "value"
```.

Здесь `-` означает добавление элемента в конец массива.

## Лучшие практики

При использовании патча Kustomize следует помнить о некоторых важных правилах:

1. **Точность пути**: Убедитесь, что путь в JSON точно соответствует целевому местоположению, включая регистр.

2. **Пошагово**: при выполнении сложных операций по установке патчей рекомендуется делать это пошагово, проверяя на каждом шаге, что сгенерированная конфигурация соответствует ожиданиям:
   ```bash
   kubectl kustomize . | kubectl apply --dry-run=client -f -
   ```.

3. **Контроль версий**: хранение файлов патчей для разных окружений в собственных каталогах упрощает управление и отслеживание изменений.

4. **Документация**: добавляйте комментарии к важным операциям патча, описывающие их использование и влияние.

## Распространенные ошибки при работе с патчами

1. **Путь не существует**: при использовании операций `replace` или `remove` убедитесь, что целевой путь существует.

2. **Индекс массива**: обратите внимание на значение индекса при работе с массивами, неправильный индекс приведет к неудаче операции.

3. **Тип значения**: убедитесь, что тип добавляемого или заменяемого значения соответствует целевому расположению. Например, нельзя заменить значение числового типа на строку.

## Практические советы

В реальных проектах рекомендуется использовать следующий рабочий процесс:

1. сначала создайте базовый файл конфигурации (base)
2. создайте отдельный файл кастомизации для каждого окружения
3. используйте патчи для обработки изменений, специфичных для конкретного окружения
4. используйте `kubectl kustomize` для предварительного просмотра сгенерированной конфигурации перед применением изменений

Пример структуры каталогов:
```
deployment/
├── base/
│   ├── deployment.yaml
│   └── kustomization.yaml
├── dev/
│   ├── kustomization-patch.yaml
└── prod/
    └── kustomization-patch.yaml
```

## Резюме

Возможности Kustomize по установке патчей обеспечивают мощное и гибкое решение для управления конфигурацией Kubernetes. Используя операции `replace`, `add` и `remove` должным образом, мы можем эффективно управлять различиями в конфигурации в разных средах, сохраняя согласованность базовой конфигурации. Главное - понять, в каких сценариях применима каждая операция, и следовать лучшим практикам, чтобы обеспечить ремонтопригодность и надежность управления конфигурацией.

- Схема процесса операции исправления
```mermaid
flowchart TD
    B["Base Configuration <br> 部署配置基础版本"] --> P1["Patch Operation 1 <br> replace: 替换已有配置 <br> 例如: 环境变量"]
    B --> P2["Patch Operation 2 <br> add: 添加新配置 <br> 例如: volumes挂载"]
    B --> P3["Patch Operation 3 <br> remove: 移除配置 <br> 例如: 禁用特性"]
    
    P1 --> K["Kustomization <br> 汇总所有补丁操作"]
    P2 --> K
    P3 --> K
    
    K --> F["Final Configuration <br> 最终生成的配置文件"]
    
    style B fill:#e1f5fe,stroke:#01579b
    style K fill:#e8f5e9,stroke:#2e7d32
    style F fill:#f3e5f5,stroke:#7b1fa2
    style P1 fill:#fff3e0,stroke:#e65100
    style P2 fill:#fff3e0,stroke:#e65100
    style P3 fill:#fff3e0,stroke:#e65100
```.

