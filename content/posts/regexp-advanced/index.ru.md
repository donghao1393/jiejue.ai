---
title: "Изучение расширенных возможностей регулярных выражений: путешествие от ripgrep к PCRE2"
date: Mon Feb 10 2025 09:13:02 GMT+0000 (Coordinated Universal Time)
slug: "regexp-advanced-features"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250210131708495.webp"
tags:
  - "регулярное выражение (математика)"
  - "ripgrep"
  - "PCRE2"
  - "обработка текста"
---

Поиск и обработка текста - фундаментальный и важный навык в повседневной работе инженера. Хотя простое сопоставление строк уже может решить многие проблемы, освоение расширенных возможностей регулярных выражений откроет новые двери при столкновении со сложными текстовыми шаблонами. В этой статье мы рассмотрим возможности утилиты ripgrep и регулярного механизма PCRE2.

<!--more-->

## ripgrep 与 PCRE2：现代文本搜索利器

### ripgrep：为什么叫这个名字？

ripgrep (сокращенно rg) - это современный инструмент поиска, написанный на языке Rust. Слово "rip" в его названии означает "Rest In Peace", что является кивком в сторону традиционного инструмента grep. ripgrep не только унаследовал основную функциональность grep, но и значительно улучшил производительность и возможности.

### 两种正则引擎的选择

По умолчанию ripgrep использует движок регулярных выражений Rust, который использует реализацию конечного автомата для более быстрого выполнения и меньшего объема памяти. Однако, если нам нужны более продвинутые возможности, мы можем включить механизм PCRE2 (Perl Compatible Regular Expressions 2) с помощью параметра `-P`.

```bash
# 使用 PCRE2 引擎
rg -P 'pattern'
```

## Unicode 模式匹配：处理多语言文本

Работа с многоязычными текстами - обычное требование в современном глобализированном мире, и PCRE2 обеспечивает мощную поддержку Unicode:

### 脚本匹配

```bash
# 匹配汉字
rg -P '\p{Script=Han}'

# 匹配日语平假名
rg -P '\p{Script=Hiragana}'

# 匹配日语片假名
rg -P '\p{Script=Katakana}'

# 匹配西里尔字母
rg -P '\p{Script=Cyrillic}'
```

### 特殊字符匹配

```bash
# 匹配表情符号
rg -P '\p{Extended_Pictographic}'

# 匹配标点符号
rg -P '\p{P}'
```

## 条件匹配：智能模式识别

Условное сопоставление позволяет выбирать различные шаблоны сопоставления на основе определенных условий. Это особенно полезно при работе с текстом в различных форматах:

```bash
# 格式：(?(?=condition)then|else)
# 示例：如果遇到数字则匹配 foo，否则匹配 bar
rg -P '(?(?=\d)foo|bar)'
```

Этот режим полезен при работе с многоформатным текстом, таким как форматы дат, телефонные номера и т. д:

```bash
# 匹配不同格式的电话号码
rg -P '(?(?=\(\d{3}\))\(\d{3}\)\s?\d{8}|\d{11})'
```

## 原子组：提高性能与精确性

Атомарные группы - это мощная, но часто упускаемая из виду функция регулярных выражений. Они повышают производительность и обеспечивают точность совпадения, отключая обратный путь.

### 基本语法

```bash
# (?>pattern) 表示一个原子组
rg -P '(?>\w+\s+)+'
```

### 实际应用

1. HTML 标签匹配：
```bash
# 匹配 HTML 标签，但排除 script 和 style 标签
rg -P '(?><(?!script|style)[^<>]+>)'
```

2. 词边界处理：
```bash
# 精确匹配单词
rg -P '\b(?>[\w-]+)\b'
```

3. 嵌套结构处理：
```bash
# 匹配不包含嵌套括号的内容
rg -P '\((?>[^()]+)\)'
```

## 否定匹配：排除不需要的内容

Негативное сопоставление - мощный инструмент, который существует во многих формах, каждая из которых имеет свою специфическую цель:

### 字符类否定

```bash
# [^...] 匹配任何不在方括号内的单个字符
rg -P '[^0-9]'  # 匹配非数字字符
```

### 向后否定查找

```bash
# (?<!pattern) 确保前面不是特定模式
rg -P '(?<!foo)bar'  # 匹配前面不是 foo 的 bar
```

### 向前否定查找

```bash
# (?!pattern) 确保后面不是特定模式
rg -P 'foo(?!bar)'  # 匹配后面不是 bar 的 foo
```

## 实战示例：复杂文本处理

Давайте рассмотрим эти возможности на практическом примере. Предположим, нам нужно извлечь все теги изображений из HTML-файла, но исключить встроенные изображения в формате base64:

```bash
rg -P '(?><img\s+(?!.*src="data:)[^>]+>)'
```

Компоненты этой модели:
1. `(? >...) ` Используются группы атомов для обеспечения общего совпадения
2. `img\s+` соответствует началу тега img.
3. `(?!. *src="data:)` Отрицательный поиск, чтобы убедиться, что это не base64-изображение.
4. `[^>]+` соответствует остальной части тега
5. `>` Соответствует концу тега

## 性能考虑

При использовании этих дополнительных функций следует помнить о некоторых моментах:

1. Атомарные группы могут повысить производительность, но их чрезмерное использование может повлиять на читабельность.
2. условное соответствие следует использовать в сценариях, где ветвление действительно необходимо.
3. сопоставление атрибутов Unicode является мощным средством, но может повлиять на производительность.
4. отрицательное соответствие следует использовать с осторожностью, чтобы избежать слишком сложных шаблонов отрицания.

## 结语

Эти расширенные возможности регулярных выражений значительно расширяют наши возможности по обработке текста. Используя эти функции в сочетании, мы можем создавать эффективные и точные решения для обработки текста. Поскольку потребность в обработке данных растет, овладение этими навыками поможет нам справиться с задачами обработки текста.