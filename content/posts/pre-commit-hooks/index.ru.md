---
title: "Освободите руки: автоматизация проверок качества кода и исправлений с помощью pre-commit"
date: 2025-03-23T17:33:47+04:00
slug: "pre-commit-hooks-automation"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250323174022149.webp"
tags:
  - "инструмент разработки"
  - "Качество кода"
  - "Git"
---

У вас когда-нибудь болела голова от проблем с пробелами в конце строки, разрывами строк в конце файла и т. д. в вашем коде? Или кто-то из вашей команды случайно отправлял код с конфиденциальной информацией или непонятным форматированием? pre-commit - это инструмент, который берет на себя все эти заботы, позволяя вам автоматически проверять и исправлять распространенные проблемы до фиксации вашего кода.

<! --подробнее-->

## Что такое pre-commit?

pre-commit - это мощный инструмент, который автоматически выполняет различные проверки и исправления перед коммитом вашего кода. Короче говоря, это "привратник" (проверяющий код), который гарантирует, что все ваши коммиты соответствуют спецификациям проекта, прежде чем они попадут в репозиторий.

Фронтенд-разработчик Сяо Ванг часто получает замечания от своих коллег, когда работает над проектом веб-сайта: "В вашем коде много пробелов в конце строк", "В конце файла нет переноса строки". Хотя эти проблемы не влияют на работу кода, они влияют на его аккуратность и последовательность. После того как он узнал о pre-commit, эти маленькие проблемы больше никогда не появлялись в его коммитах.

## Зачем мне нужен pre-commit?

Представьте себе следующий сценарий:

- Вы усердно работали над своим кодом, закоммитили его, а затем получили кучу замечаний о проблемах с форматированием на ревью кода.
- Один из членов команды случайно коммитит API-ключ или приватный ключ в кодовую базу.
- Несоответствие стиля кода приводит к тому, что система контроля версий отображает большое количество бессмысленных различий.
- Частая необходимость исправлять простые проблемы, которые могли бы быть обнаружены и исправлены автоматически

pre-commit автоматически обнаруживает и исправляет эти проблемы до того, как они попадают в репозиторий, экономя время и усилия.

## Начало работы с pre-commit

### Установка pre-commit

Сначала установите pre-commit с помощью pip:

```bash
pip install pre-commit
```.

### Создайте файл конфигурации

Создайте файл с именем `.pre-commit-config.yaml` в корневом каталоге проекта:

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0  # 使用最新版本
    hooks:
      - id: trailing-whitespace  # 删除行尾空白
      - id: end-of-file-fixer    # 确保文件以换行符结束
      - id: check-yaml           # 检查YAML文件语法
      - id: check-added-large-files  # 防止提交大文件
```.

### Установите крючки Git

Выполните следующую команду в каталоге проекта, чтобы установить pre-commit в Git hooks:

```bash
pre-commit install
```

Теперь при каждом запуске команды `git commit` pre-commit будет автоматически выполнять проверки, указанные в конфигурационном файле, и по возможности автоматически исправлять проблему.

### Посмотреть эффект

Когда вы выполните команду `git commit`, вы увидите вывод, похожий на этот:

```
trim trailing whitespace.................................................Passed
fix end of files.........................................................Passed
check yaml...............................................................Passed
check for added large files..............................................Passed
```

Если все проверки пройдут, фиксация будет продолжена; если какие-либо проверки пройдут неудачно и не будут исправлены автоматически, фиксация будет заблокирована, и вам будет предложено исправить проблему вручную.

## Общие крючки для предварительной фиксации

Вот некоторые из наиболее полезных крючков предварительной коммисии:

### Проверка базы

- `trailing-whitespace`: Удалять пробельные символы в конце строки.
- `end-of-file-fixer`: Убедитесь, что файлы завершаются новой строкой.
- `check-yaml/json/xml/toml`: Проверьте все типы форматов конфигурационных файлов.
- `check-merge-conflict`: Проверка на наличие неразрешенных флагов конфликтов слияния.
- `check-case-conflict`: Проверка конфликтов регистров имен файлов.

### `check-case-conflict`: Проверка конфликтов регистров имен файлов.

- `detect-private-key`: Проверка случайных фиксаций закрытых ключей.
- `no-commit-to-branch`: Предотвращение коммитов непосредственно в основную ветку (например, main).
- `detect-aws-credentials`: Определять учетные данные AWS.

### Форматирование кода

- Python: `black`, `isort`, `flake8`
- JavaScript: `prettier`, `eslint`
- Другие языки: `clang-format`, `gofmt`, `ktlint` и другие.

### Более полный пример конфигурации.

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-added-large-files
      - id: detect-private-key
      - id: check-merge-conflict
      
  # Python 代码格式化
  - repo: https://github.com/psf/black
    rev: 24.2.0
    hooks:
      - id: black
        
  # Python 导入排序
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        
  # Python 代码质量检查
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.3.0
    hooks:
      - id: ruff
        args: [--fix]
```

### Расширенное использование

### Запустите проверку вручную

Вы можете запускать проверки без фиксации:

```bash
pre-commit run --all-files  # 检查所有文件
pre-commit run trailing-whitespace  # 只运行特定钩子
```

### Крючки для определенных типов файлов

Крючки могут быть настроены на проверку только определенных типов файлов:

```yaml
- id: black
  types: [python]
  
- id: eslint
  files: \.(js|ts|jsx|tsx)$
```.

### Пользовательские крючки

Вы можете создавать собственные хуки для запуска пользовательских скриптов:

```yaml
- repo: local
  hooks:
    - id: custom-script
      name: 运行自定义检查脚本
      entry: ./scripts/custom-check.sh
      language: script
```.

## Продвижение прекоммита в командах

Если вы хотите продвигать использование pre-commit в своей команде, вы можете это сделать:

1. добавить инструкции по установке и использованию в README проекта
2. добавить проверки pre-commit в процесс CI/CD, чтобы убедиться, что все коммиты соответствуют спецификации
3. объяснить, как он сокращает время, затрачиваемое на решение проблем с форматированием при проверке кода
4. подчеркните его способность автоматизировать исправления, сокращая ручной труд разработчиков

## Часто задаваемые вопросы

### Влияет ли pre-commit на скорость моих коммитов?

Это добавит некоторое время на коммит, но преимущества значительно перевешивают затраты. Большинство проверок очень быстрые и добавят всего несколько секунд, но сэкономят много последующего времени на устранение проблем.

### Как пропустить проверки для конкретного коммита?

Если вам нужно временно пропустить проверку, вы можете использовать:

```bash
git commit -m "message" --no-verify
```.

Однако используйте эту опцию с осторожностью, так как она обойдет все проверки.

### Как обновить версию хука?

Выполните следующую команду, чтобы обновить все крючки до последней версии:

```bash
pre-commit autoupdate
```

## Резюме

pre-commit - это мощный и гибкий инструмент, который поможет вам и вашей команде автоматизировать проверку качества кода и исправление проблем. Автоматически выявляя и исправляя общие проблемы до фиксации кода, он не только улучшает качество кода, но и снижает нагрузку на разработчиков и затраты на общение в команде.

Начните использовать pre-commit, чтобы оставить в прошлом эти утомительные проблемы с качеством кода и сосредоточиться на разработке, которая действительно важна!

Вы когда-нибудь задумывались о том, какие еще аспекты разработки и качества кода можно улучшить с помощью средств автоматизации, кроме проверок до коммита? Например, автоматизированное тестирование, непрерывная интеграция, сканирование кода и т. д. Попробуйте объединить эти инструменты, чтобы создать полноценную систему обеспечения качества кода, и какое улучшение опыта разработки это принесет?
