---
title: "Освободите руки: автоматизация проверок качества кода и исправлений с помощью pre-commit"
date: Sun Mar 23 2025 13:33:47 GMT+0000 (Coordinated Universal Time)
slug: "pre-commit-hooks-automation"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250323174022149.webp"
tags:
  - "инструмент разработки"
  - "Качество кода"
  - "Git"
---

У вас когда-нибудь болела голова от проблем с пробелами в конце строки, разрывами строк в конце файла и т. д. в вашем коде? Или кто-то из вашей команды случайно отправлял код с конфиденциальной информацией или непонятным форматированием? pre-commit - это инструмент, который берет на себя все эти заботы, позволяя вам автоматически проверять и исправлять распространенные проблемы до фиксации вашего кода.

<!--more-->

## 什么是 pre-commit？

pre-commit - это мощный инструмент, который автоматически выполняет различные проверки и исправления перед коммитом вашего кода. В двух словах, это "привратник" (инспектор кода), который следит за вашим кодом до того, как он попадает в репозиторий, и убеждается, что все ваши коммиты соответствуют спецификациям проекта.

Фронтенд-разработчик Сяо Ванг часто получает замечания от своих коллег, когда работает над проектом веб-сайта: "В вашем коде много пробелов в конце строки" и "В конце файла нет переноса строки". Хотя эти проблемы не влияют на работу кода, они влияют на его аккуратность и последовательность. После того как он узнал о pre-commit, эти маленькие проблемы больше никогда не появлялись в его коммитах.

## 为什么需要 pre-commit？

Представьте себе следующий сценарий:

- Вы усердно работали над своим кодом, отправили его, а затем получили кучу замечаний о проблемах с форматированием на ревью кода
- Один из членов команды случайно занес в кодовую базу API-ключ или закрытый ключ.
- Несогласованные стили кода, из-за которых система контроля версий показывает множество бессмысленных различий.
- Частая необходимость исправлять простые проблемы, которые могли бы быть обнаружены и исправлены автоматически

pre-commit автоматически обнаруживает и исправляет эти проблемы до того, как они попадают в кодовую базу, что значительно экономит время и усилия.

## 快速上手 pre-commit

### 安装 pre-commit

Сначала установите pre-commit с помощью pip:

```bash
pip install pre-commit
```

### 创建配置文件

Создайте файл `.pre-commit-config.yaml` в корневом каталоге проекта:

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0  # 使用最新版本
    hooks:
      - id: trailing-whitespace  # 删除行尾空白
      - id: end-of-file-fixer    # 确保文件以换行符结束
      - id: check-yaml           # 检查YAML文件语法
      - id: check-added-large-files  # 防止提交大文件
```

### 安装Git钩子

Выполните следующую команду в каталоге вашего проекта, чтобы установить pre-commit в ваши Git-хуки:

```bash
pre-commit install
```

Теперь, когда вы выполняете команду `git commit`, pre-commit автоматически выполняет проверки, указанные в файле конфигурации, и по возможности автоматически устраняет проблему.

### 查看效果

Когда вы выполните команду `git commit`, вы увидите вывод, который выглядит следующим образом:

```
trim trailing whitespace.................................................Passed
fix end of files.........................................................Passed
check yaml...............................................................Passed
check for added large files..............................................Passed
```

Если все проверки пройдут, фиксация будет продолжена; если какие-либо проверки не пройдут и не будут исправлены автоматически, фиксация будет заблокирована, и вам будет предложено исправить проблему вручную.

## 常用的 pre-commit 钩子

Вот некоторые из наиболее полезных крючков предварительной коммисии:

### 基础检查

- `trailing-whitespace`: удаляет пробельные символы в конце строк
- `end-of-file-fixer`: убедитесь, что файлы завершаются переводом строки
- `check-yaml/json/xml/toml`: проверка различных форматов файлов конфигурации
- `check-merge-conflict`: проверка на наличие неразрешенных флагов конфликтов слияния
- `check-case-conflict`: проверка конфликтов регистров имен файлов

### 安全性检查

- `detect-private-key`: Определяет, был ли случайно зафиксирован закрытый ключ.
- `no-commit-to-branch`: предотвращает фиксацию непосредственно в главную ветку (например, main).
- `detect-aws-credentials`: обнаружение учетных данных AWS

### 代码格式化

- Python: `black`, `isort`, `flake8`
- JavaScript: `prettier`, `eslint`.
- Другие языки: `clang-format`, `gofmt`, `ktlint` и др.

### 一个更完整的配置示例

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-added-large-files
      - id: detect-private-key
      - id: check-merge-conflict
      
  # Python 代码格式化
  - repo: https://github.com/psf/black
    rev: 24.2.0
    hooks:
      - id: black
        
  # Python 导入排序
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        
  # Python 代码质量检查
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.3.0
    hooks:
      - id: ruff
        args: [--fix]
```

## 进阶用法

### 手动运行检查

Вы можете запустить проверку, не выполняя фиксацию:

```bash
pre-commit run --all-files  # 检查所有文件
pre-commit run trailing-whitespace  # 只运行特定钩子
```

### 针对特定文件类型的钩子

Крючки можно настроить на проверку только определенных типов файлов:

```yaml
- id: black
  types: [python]
  
- id: eslint
  files: \.(js|ts|jsx|tsx)$
```

### 自定义钩子

Вы можете создавать собственные крючки для запуска пользовательских сценариев:

```yaml
- repo: local
  hooks:
    - id: custom-script
      name: 运行自定义检查脚本
      entry: ./scripts/custom-check.sh
      language: script
```

## 在团队中推广 pre-commit

Если вы хотите продвигать использование pre-commit в своей команде, вы можете это сделать:

1. добавьте инструкции по установке и использованию в README проекта.
2. добавьте в процесс CI/CD проверку перед коммитом, чтобы убедиться, что все коммиты соответствуют спецификации
3. объясните, как он сокращает время, затрачиваемое на решение проблем с форматированием при проверке кода
4. подчеркните его способность автоматизировать исправления, сокращая ручной труд разработчиков

## 常见问题解答

### pre-commit 是否会影响我的提交速度？

Хотя это и потребует некоторого времени на выполнение, преимущества значительно перевешивают затраты. Большинство проверок выполняются очень быстро и занимают всего несколько секунд, но позволяют сэкономить много последующего времени на устранение проблем.

### 如何跳过特定提交的检查？

Его можно использовать, если вам действительно нужно временно пропустить чек:

```bash
git commit -m "message" --no-verify
```

Однако используйте эту опцию с осторожностью, так как она обойдет все проверки.

### 如何更新钩子版本？

Выполните следующую команду, чтобы обновить все крючки до последней версии:

```bash
pre-commit autoupdate
```

## 总结

pre-commit - это мощный и гибкий инструмент, который поможет вам и вашей команде автоматизировать проверку качества кода и исправление проблем. Автоматическое обнаружение и исправление типичных проблем до коммитов кода позволяет не только повысить качество кода, но и снизить нагрузку на разработчиков и затраты на общение в команде.

Начните использовать pre-commit, пусть эти утомительные проблемы с качеством кода останутся в прошлом, и сосредоточьтесь на разработке, которая действительно важна!

Вы когда-нибудь задумывались, какие еще аспекты разработки и качества кода можно улучшить с помощью средств автоматизации, кроме проверок перед коммитом? Например, автоматизированное тестирование, непрерывная интеграция, сканирование кода и так далее. Попробуйте объединить эти инструменты, чтобы создать полноценную систему обеспечения качества кода, и какое улучшение опыта разработки это принесет?