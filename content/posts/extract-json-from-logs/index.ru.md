---
title: "Извлечение и анализ сообщений JSON из журналов"
date: 2025-02-16T20:34:33+04:00
slug: "extract-json-from-logs"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250216203652932.webp"
tags:
  - "Linux"
  - "эксплуатация и обслуживание (O&M)"
  - "анализ журнала"
---

В оперативной работе нам часто приходится извлекать и анализировать специфическую информацию из файлов журналов. Недавно я столкнулся со сценарием, в котором мне нужно было извлечь и подсчитать различные типы вызовов API из файла журнала, содержащего большое количество сообщений в формате JSON. В этом посте мы расскажем о том, как использовать инструменты командной строки Linux для эффективного выполнения этой работы.

<! --подробнее-->

## Проблемный фон

Предположим, у нас есть лог-файл системы микросервисов `/var/log/app-server.log`, который содержит большое количество сообщений в формате JSON, подобных этому:

```
2025-02-15T20:04:25.720Z [AppServer] [info] Message from client: {"method":"resources/list","params":{},"jsonrpc":"2.0","id":1347}
2025-02-15T20:04:25.721Z [AppServer] [info] Message from client: {"method":"prompts/list","params":{},"jsonrpc":"2.0","id":1348}
```

Наши цели состоят в том, чтобы:
1. извлечь все JSON-сообщения из этих журналов
2. сгруппировать вызовы API одного типа (один и тот же метод) в категории.
3. игнорировать различные значения id для каждого вызова.

## Первая попытка: простая, но неполная

Сначала мы можем попробовать сделать это следующим образом:

```bash
cat /var/log/app-server.log | rg 'Message from client' | awk '{print $7}' | sort -u
```.

Эта комбинация команд:
- Чтение лог-файла с помощью `cat`.
- Используйте __PROTECTED_INLINE_CODE__9__ (ripgrep, более быстрый grep), чтобы найти строку, содержащую "Сообщение от клиента".
- Извлеките столбец 7 (содержимое JSON) с помощью `awk`.
- Удалите вес с помощью `sort -u`.

Кажется разумным, но есть две проблемы с этим методом:
1. разные идентификаторы в JSON могут привести к тому, что фактически один и тот же вызов будет рассматриваться как разный журнал.
2. если формат журнала немного изменится, например, содержимое JSON будет охватывать несколько столбцов, __PROTECTED_INLINE_CODE__12__ будет извлечен неполностью.

## Программа улучшений: точное извлечение и унифицированная обработка

Давайте улучшать ее шаг за шагом:

Во-первых, используйте опцию `rg` из `-o` для извлечения полного JSON напрямую:

```bash
cat /var/log/app-server.log | rg -o '\{.*\}'
```.

`-o` означает, что будет выведена только найденная часть, `\{.*\}` будет соответствовать всему от начала `{` до `}`. конец.

Затем JSON обрабатывается с помощью `jq` для унификации идентификаторов:

```bash
cat /var/log/app-server.log | rg -o '\{.*\}' | jq -c '. | .id = 0' | sort -u
```

ЗДЕСЬ:
- `jq -c` означает вывод JSON в сжатом формате (одна строка на запись)
- `. | .id = 0` устанавливает id каждой записи в ноль.
- `sort -u` отменить выделение

В итоге мы получаем чистый вывод:

```json
{"method":"prompts/list","params":{},"jsonrpc":"2.0","id":0}
{"method":"resources/list","params":{},"jsonrpc":"2.0","id":0}
```

## Дальнейшая оптимизация: только ключевая информация

Если вы хотите увидеть только различные методы, вы можете сделать следующее:

```bash
cat /var/log/app-server.log | rg -o '\{.*\}' | jq -c '. | .method' | sort -u
```

Вывод будет более кратким:

```
"prompts/list"
"resources/list"
```.

## Резюме

На этом примере мы научились:
1. использовать `rg -o` для точного извлечения содержимого JSON
2. использовать `jq` для обработки и нормализации JSON
3. статистика дедупликации с помощью `sort -u`.

Эти техники применимы не только для обработки журналов вызовов API, но и для любого файла журнала, содержащего данные в формате JSON. Освоение комбинированного использования этих инструментов командной строки может значительно повысить эффективность анализа журналов.

## Расширенное чтение

- [ripgrep documentation](https://github.com/BurntSushi/ripgrep/blob/master/GUIDE.md): узнайте больше о расширенном использовании ripgrep.
- [Руководство по jq](__PROTECTED_LINK_URL__27__): изучите мощные возможности jq по обработке JSON!
- [Команды обработки текста в Linux](https://linuxhandbook.com/text-processing-commands/): Узнайте больше об инструментах обработки текста.
