---
title: "Устранение неполадок с автоматическим отступом пасты Neovim в сеансах Tmux"
date: 2025-02-08T13:43:58+04:00
slug: "tmux-nvim-paste-indent"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250208140012411.webp"
tags:
  - "Neovim"
  - "Tmux"
  - "скрининг проблем"
  - "LazyVim"
  - "автоматическое вдавливание"
---

В среде разработки, использующей tmux + Neovim, вы периодически сталкиваетесь с некоторыми, казалось бы, простыми, но запутанными проблемами. Сегодня я расскажу о проблеме с путаницей автоотступов при вставке кода при использовании Neovim в сессии tmux, а также о ее неожиданном решении.

<! ---далее-->

## Описание проблемы

В запущенной сессии tmux при редактировании файла с помощью Neovim (настроенного с помощью LazyVim) при вставке следующего кода:

```fish
   1   │ #!/usr/bin/env fish
   2   │ source ~/.config/fish/config.fish
   3   │ npx $argv
```.

После вставки код выглядит следующим образом:

```fish
   1   │ #!/usr/bin/env fish
      2   │ source ~/.config/fish/config.fish
         3   │ npx $argv
```

Каждая строка имеет дополнительный отступ, что явно не тот результат, который нам нужен.

## Процесс исследования

### 1. Попробуйте изменить конфигурацию Neovim.

Сначала я попробовал добавить параметр `pastetoggle` к `~/.config/nvim/lua/config/options.lua`:

```lua
vim.opt.pastetoggle = '<F2>'
```

Но это привело к тому, что Neovim сообщил об ошибке при запуске:

```
Failed loading config.options
vim/_options.lua:0: Unknown option 'pastetoggle'
```.

Если посмотреть на [связанное обсуждение на Stack Overflow](https://stackoverflow.com/questions/76687544/emulate-pastetoggle-in-neovim), то окажется, что опция `pastetoggle` была удалена из Neovim.

### 2. Пробуем другие параметры конфигурации Neovim

Затем было опробовано несколько различных конфигурационных комбинаций:

```lua
-- 方案一：基础设置
vim.opt.paste = false
vim.opt.clipboard = 'unnamedplus'

-- 方案二：调整缩进相关选项
vim.opt.paste = false
vim.opt.autoindent = true
vim.opt.smartindent = true
```.

Хотя все эти конфигурации загрузились нормально, они не решили проблему.

### 3. Временные решения

В процессе поиска и устранения неисправностей было обнаружено, что использование команды `:set paste` временно решает проблему. Это дало нам подсказку, что проблема может быть связана с режимом вставки Neovim.

### 4. Тест изоляции среды

Чтобы более точно определить проблему, мы провели следующие тесты:

1. Сбросьте конфигурацию Neovim:
```fish
mv nvim nvim.lazy.bak
git clone https://github.com/LazyVim/starter ~/.config/nvim
```.

2. Протестировали в разных средах:
   - Использование Neovim в обычном терминале (не tmux): **проблемы не повторяются**.
   - Использование Neovim в новой сессии tmux: **проблемы не повторяются**.
   - Использование Neovim в существующем сеансе tmux: **проблема сохраняется**.

### 5. Окончательное решение

На удивление, окончательное решение очень простое:

1. выйти из текущей сессии tmux
2. заново создайте новую сессию tmux

Проблема была решена. Это явление напоминает нам о том, что иногда проблема не обязательно кроется в конфигурации, но может быть вызвана и состоянием времени выполнения.

## Технический анализ

Эта проблема характеризуется тем, что:
1. она возникает только в определенных сессиях tmux
2. конфигурация кажется нормальной (проверяется командами типа `:set paste?`)
3. пересоздание сессии решает проблему

Это явление "просто перезапустить" обычно означает:
- Либо состояние времени выполнения tmux было случайно изменено.
- Либо состояние времени выполнения tmux было случайно изменено, либо какое-то состояние терминала (например, режим пасты со скобками) является ненормальным.

## Предложение

Если вы столкнулись с подобными проблемами, выполните следующие действия:

1. используйте `:set paste` в качестве временного решения
2. проверьте, возникает ли проблема только в среде tmux.
3. если да, попробуйте пересоздать сессию tmux
4. если проблема возникает часто, используйте `tmux show-options -g` и `tmux show-window-options -g`, чтобы сравнить разницу между нормальным и ненормальным состояниями.

## Ссылка

- [Stack Overflow: Эмуляция pastetoggle в Neovim](https://stackoverflow.com/questions/76687544/emulate-pastetoggle-in-neovim)
- [Stack Overflow: Отключение автоматического отступа при вставке текста в vim](https://stackoverflow.com/questions/2514445/turning-off-auto-indent-when-pasting-text-into-vim)
- [LazyVim Starter Template](https://github.com/LazyVim/starter)

## Резюме

Этот случай показывает нам, что при разработке программного обеспечения иногда решение проблемы может быть удивительно простым. Не ограничивайтесь изменениями конфигурации, но и учитывайте влияние состояния времени выполнения. Кроме того, систематическая изоляция тестового окружения может помочь нам быстрее найти проблему.
