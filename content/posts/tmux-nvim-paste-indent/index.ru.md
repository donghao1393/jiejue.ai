---
title: "Устранение неполадок с автоматическим отступом пасты Neovim в сеансах Tmux"
date: 2025-02-08T13:43:58+04:00
slug: "tmux-nvim-paste-indent"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250208140012411.webp"
tags:
  - "Neovim"
  - "Tmux"
  - "скрининг проблем"
  - "LazyVim"
  - "автоматическое вдавливание"
---

В среде разработки, использующей tmux + Neovim, вы периодически сталкиваетесь с некоторыми, казалось бы, простыми, но запутанными проблемами. Сегодня я расскажу о проблеме с путаницей автоотступов при вставке кода при использовании Neovim в сессии tmux, а также о ее неожиданном решении.

<!--more-->

## 问题描述

В запущенной сессии tmux при редактировании файла с помощью Neovim (настроенного с помощью LazyVim), при вставке следующего кода:

```fish
   1   │ #!/usr/bin/env fish
   2   │ source ~/.config/fish/config.fish
   3   │ npx $argv
```

После вставки кода он становится таким:

```fish
   1   │ #!/usr/bin/env fish
      2   │ source ~/.config/fish/config.fish
         3   │ npx $argv
```

В каждой строке добавлены лишние отступы, что, очевидно, не тот результат, который нам нужен.

## 排查过程

### 1. 尝试修改 Neovim 配置

Сначала я попробовал добавить настройку `pastetoggle` в `~/.config/nvim/lua/config/options.lua`:

```lua
vim.opt.pastetoggle = '<F2>'
```

Но это приводит к тому, что Neovim сообщает об ошибке при запуске:

```
Failed loading config.options
vim/_options.lua:0: Unknown option 'pastetoggle'
```

При проверке [связанного обсуждения на Stack Overflow](https://stackoverflow.com/questions/76687544/emulate-pastetoggle-in-neovim) выяснилось, что опция `pastetoggle` была удалена.

### 2. 尝试其他 Neovim 配置方案

Затем попробовал несколько различных комбинаций конфигурации:

```lua
-- 方案一：基础设置
vim.opt.paste = false
vim.opt.clipboard = 'unnamedplus'

-- 方案二：调整缩进相关选项
vim.opt.paste = false
vim.opt.autoindent = true
vim.opt.smartindent = true
```

Хотя эти конфигурации загрузились правильно, они не решили проблему.

### 3. 临时解决方案

В процессе поиска и устранения неисправностей мы обнаружили, что использование команды `:set paste` временно решает проблему. Это дало нам подсказку, что проблема может быть связана с режимом вставки Neovim.

### 4. 环境隔离测试

Чтобы более точно определить проблему, мы провели следующие тесты:

1. 重置 Neovim 配置：
```fish
mv nvim nvim.lazy.bak
git clone https://github.com/LazyVim/starter ~/.config/nvim
```

2. Тестирование в различных средах:
   - Использование Neovim в обычном терминале (не tmux): **проблемы не повторяются**.
   - Использование Neovim в новой сессии tmux: **проблема не повторяется**.
   - Использование Neovim в существующем сеансе tmux: **проблема сохраняется**.

### 5. 最终解决方案

Удивительно, но окончательное решение очень простое:

1. выйти из текущей сессии tmux
2. создайте новый сеанс tmux.

Проблема была решена. Это явление напоминает нам о том, что иногда проблема не обязательно кроется в конфигурации, но может быть вызвана и состоянием времени выполнения.

## 技术分析

Эта проблема характеризуется следующим:
1. она возникает только в определенных сессиях tmux
2. конфигурация выглядит нормально (проверяется командами типа `:set paste?`)
3. проблема решается путем пересоздания сессии

Это явление "просто перезагрузиться" обычно означает:
- Либо состояние времени выполнения tmux было случайно изменено.
- Либо состояние времени выполнения tmux было случайно изменено, либо какое-то состояние терминала (например, режим пасты в скобках) является ненормальным.

## 建议

Если у вас возникла подобная проблема, вы можете выполнить следующие действия, чтобы решить ее:

1. используйте `:set paste` в качестве временного решения
2. проверьте, происходит ли это только в среде tmux.
3. если да, попробуйте пересоздать сессию tmux
4. если проблема возникает часто, используйте `tmux show-options -g` и `tmux show-window-options -g`, чтобы сравнить разницу между нормальным и ненормальным состоянием

## 参考资料

- [Stack Overflow: Эмулировать pastetoggle в Neovim](https://stackoverflow.com/questions/76687544/emulate-pastetoggle-in-neovim)
- [Stack Overflow: Отключение автоматического отступа при вставке текста в vim](https://stackoverflow.com/questions/2514445/turning-off-auto-indent- when-pasting-text-into-vim)
- [LazyVim Starter Template](https://github.com/LazyVim/starter)

## 总结

Этот случай показывает нам, что при разработке программного обеспечения иногда решение проблемы может быть удивительно простым. Не ограничивайтесь изменениями конфигурации, но и учитывайте влияние состояния времени выполнения. Кроме того, систематическая изоляция тестовой среды может помочь нам быстрее обнаружить проблемы.