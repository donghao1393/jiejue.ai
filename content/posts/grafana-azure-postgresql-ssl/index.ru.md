---
title: "Устранение проблем с SSL/TLS при подключении Grafana к Azure PostgreSQL"
date: 2025-03-04T17:14:20+04:00
slug: "solving-grafana-azure-postgresql-ssl-tls-issues"
draft: false
cover: "https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250304171719989.webp"
tags:
  - "Лазурь"
  - "Grafana"
  - "PostgreSQL"
  - "SSL/TLS"
  - "Визуализация данных"
---

Проблемы с подключением SSL/TLS часто ставят разработчиков в тупик при настройке Grafana для подключения к базам данных Azure PostgreSQL. В этой статье мы расскажем о простом на первый взгляд, но не слишком интуитивном решении, которое поможет вам быстро устранить такие проблемы с подключением.

<! --подробнее-->

## История проблемы

Многие разработчики сталкиваются с ошибками SSL/TLS при попытке подключить Grafana к гибкому серверу Azure PostgreSQL. Документация Azure обычно не содержит подробностей о том, как справиться с этими конкретными сценариями, особенно если вы подключаетесь, используя IP-адрес, а не доменное имя.

Наиболее распространенные ошибки включают:

- __PROTECTED_INLINE_CODE__2__ при включенном SSL
- Когда режим SSL установлен на verify-full: _`tls: failed to verify certificate: x509: cannot validate certificate for X.X.X.X because it doesn't contain any IP SANs`
- Когда SSL отключен: ___ПРОТЕКТИРОВАННЫЙ_ИНЛАЙН_КОД__4__

Эти ошибки указывают на то, что Azure PostgreSQL принудительно устанавливает SSL-соединение, но при этом возникают различные проблемы с проверкой сертификата.

## Анализ причин ошибок

### 1. Azure PostgreSQL принудительно устанавливает SSL-соединение

Служба Azure PostgreSQL по умолчанию настроена на принудительное использование SSL-соединения для защиты передачи данных. Именно поэтому при попытке отключить SSL-соединение вы получаете отказ в подключении.

### 2. Проблемы с проверкой сертификата

Ошибка "IP SANs" возникает при подключении с IP-адресом, поскольку сертификаты серверов Azure обычно содержат только доменное имя, а не IP-адрес в качестве альтернативного имени субъекта (SAN).

### 3. Проблемы с цепочкой доверия корневого сертификата

Ошибка "сертификат подписан неизвестным органом" обычно означает, что клиент не доверяет органу, выдавшему сертификат сервера.

## Решение

После нескольких тестов мы нашли удивительно простое решение:

### Лучший способ настроить его

В настройках источника данных Grafana PostgreSQL:

1. Оставьте опцию SSL как "Required" или установите режим SSL на "verify-ca".
2. **НЕ** предоставляйте пользовательский сертификат CA (оставьте поле TLS/SSL Root Certificate пустым).
3. убедитесь, что опция "Пропустить проверку TLS" снята.

Все очень просто!

### Почему это работает?

Современные образы контейнеров Grafana уже содержат корневые сертификаты от Microsoft и DigiCert, которые являются теми самыми центрами сертификации, которые используются в Azure PostgreSQL. Когда вы не указываете свой собственный сертификат центра сертификации, Grafana использует встроенное хранилище сертификатов системы, которое обычно уже содержит эти корневые сертификаты.

Если же вы попытаетесь предоставить эти сертификаты вручную, проверка может не пройти из-за проблем с форматированием, ошибок в пути или неполной цепочки сертификатов.

## Почему вы не можете использовать другие режимы SSL

- **SSL disabled**: невозможно, поскольку Azure принудительно устанавливает SSL-соединение
- **SSL verify-full**: не работает при подключении с IP-адресом, поскольку сертификат не содержит IP SAN; работает только при подключении с полным доменным именем

## Иллюстрация процесса подключения SSL

```mermaid
sequenceDiagram
    participant G as Grafana
    participant P as Azure PostgreSQL
    
    G->>P: 连接请求
    P->>G: 要求SSL连接
    G->>P: SSL握手
    P->>G: 发送服务器证书
    Note over G: 验证证书是否由<br>受信任的CA签名
    G->>P: 建立加密连接
    P->>G: 连接成功
```.

## Проверка конфигурации

Чтобы убедиться, что SSL-соединение было установлено правильно, можно воспользоваться встроенными функциями PostgreSQL:

```sql
SELECT datname as "Database name", usename as "User name", ssl, client_addr, application_name, backend_type
FROM pg_stat_ssl
JOIN pg_stat_activity
ON pg_stat_ssl.pid = pg_stat_activity.pid
ORDER BY ssl;
```.

Запрос должен показать колонку ssl для соединения Grafana как "t" (true).

## Резюме и лучшие практики

1. используйте режим "verify-ca" в Grafana для подключения к Azure PostgreSQL.
2. не предоставляйте сертификаты ЦС вручную, полагайтесь на существующее системное хранилище сертификатов контейнера Grafana.
3. поддерживайте образ контейнера Grafana в актуальном состоянии, чтобы получать последние обновления сертификатов ЦС.
4. по возможности подключайтесь, используя доменное имя вместо IP-адреса, чтобы использовать более безопасный режим "verify-full".

Такая конфигурация обеспечивает безопасное соединение, избегая излишней сложности. Если Azure обновит корневой сертификат в будущем, просто обновите образ контейнера Grafana, чтобы сохранить работоспособность соединения.

Иногда техническое решение заключается в том, чтобы сделать меньше, а не больше. Надеюсь, эта статья поможет вам не тратить время на настройку SSL!
