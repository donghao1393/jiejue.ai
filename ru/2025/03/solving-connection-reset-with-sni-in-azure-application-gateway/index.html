<!doctype html><html lang=ru-RU x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Устранение неполадок при сбросе соединений в средах частной сети шлюза приложений Azure: критическая роль параметров SNI | ЛюбимРешать</title><link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://jiejue.ai/ru/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/><meta name=author content="董昊"><meta name=description content="При переносе Azure Application Gateway из общедоступной сети в частную среду, даже если конфигурация кажется правильной, вы можете неожиданно столкнуться с проблемой сброса TLS-соединений. В этой статье мы расскажем о простой на первый взгляд, но часто упускаемой из виду ключевой настройке: параметре SNI (Server Name Indication) и о том, как с его помощью можно решить проблемы со сбросом соединений.
"><meta name=keywords content="Лазурь,Ретикуляция,Шлюз Приложений,Устранение Неисправностей"><meta name=generator content="Hugo 0.148.2"><meta property="og:url" content="https://jiejue.ai/ru/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/"><meta property="og:site_name" content="ЛюбимРешать"><meta property="og:title" content="Устранение неполадок при сбросе соединений в средах частной сети шлюза приложений Azure: критическая роль параметров SNI"><meta property="og:description" content="При переносе Azure Application Gateway из общедоступной сети в частную среду, даже если конфигурация кажется правильной, вы можете неожиданно столкнуться с проблемой сброса TLS-соединений. В этой статье мы расскажем о простой на первый взгляд, но часто упускаемой из виду ключевой настройке: параметре SNI (Server Name Indication) и о том, как с его помощью можно решить проблемы со сбросом соединений."><meta property="og:locale" content="ru_RU"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-18T20:59:56+04:00"><meta property="article:modified_time" content="2025-08-13T15:03:02+00:00"><meta property="article:tag" content="Лазурь"><meta property="article:tag" content="Ретикуляция"><meta property="article:tag" content="Шлюз Приложений"><meta property="article:tag" content="Устранение Неисправностей"><meta name=twitter:card content="summary"><meta name=twitter:title content="Устранение неполадок при сбросе соединений в средах частной сети шлюза приложений Azure: критическая роль параметров SNI"><meta name=twitter:description content="При переносе Azure Application Gateway из общедоступной сети в частную среду, даже если конфигурация кажется правильной, вы можете неожиданно столкнуться с проблемой сброса TLS-соединений. В этой статье мы расскажем о простой на первый взгляд, но часто упускаемой из виду ключевой настройке: параметре SNI (Server Name Indication) и о том, как с его помощью можно решить проблемы со сбросом соединений."><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=Повернуть!><div class="h-10 rounded-full"><img src=/favicon.ico alt=爱解决></div></div><div><a href=/ru class="text-lg font-semibold cursor-pointer">爱解决</a><div class="text-base-content/60 text-sm">用AI为人民服务</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/ru/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/ru/posts title=Архивы><ion-icon name=archive></ion-icon>Архивы</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/ru/tags title="Все теги"><ion-icon name=pricetags></ion-icon>Все теги</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/ru/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/ru/posts title=Архивы><ion-icon name=archive></ion-icon>Архивы</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/ru/tags title="Все теги"><ion-icon name=pricetags></ion-icon>Все теги</a></li></ul></div><div class="dropdown dropdown-end dropdown-hover language-switcher"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" title="Переключить язык"><ion-icon class=group-hover:text-primary-content name=language-outline></ion-icon><span class="ml-1 hidden md:inline group-hover:text-primary-content language-name">Русский</span></div><ul tabindex=0 class="dropdown-content menu bg-base-100 rounded-box z-[1] shadow-xl border border-base-content/20" style=min-width:6rem;width:auto><li><a href=/zh/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/ class="flex items-center gap-2"><span class="flag flag-cn"></span>
<span class=language-name>中文</span></a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="Устранение неполадок при сбросе соединений в средах частной сети шлюза приложений Azure: критическая роль параметров SNI"><meta itemprop=description content="При переносе Azure Application Gateway из общедоступной сети в частную среду, даже если конфигурация кажется правильной, вы можете неожиданно столкнуться с проблемой сброса TLS-соединений. В этой статье мы расскажем о простой на первый взгляд, но часто упускаемой из виду ключевой настройке: параметре SNI (Server Name Indication) и о том, как с его помощью можно решить проблемы со сбросом соединений."><meta itemprop=datePublished content="2025-03-18T20:59:56+04:00"><meta itemprop=dateModified content="2025-08-13T15:03:02+00:00"><meta itemprop=wordCount content="6166"><meta itemprop=keywords content="Лазурь,Ретикуляция,Шлюз Приложений,Устранение Неисправностей"><header><h1 itemprop=headline>Устранение неполадок при сбросе соединений в средах частной сети шлюза приложений Azure: критическая роль параметров SNI</h1><p class=text-sm><span data-format=luxon>2025-03-18T20:59:56+04:00</span>
| <span>13 минут чтения</span>
| <span>Обновлено
<span data-format=luxon>2025-08-13T15:03:02Z</span></span></p><div class="flex justify-between"><div class="flex items-center"><span>@</span>
<span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>董昊</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%d0%a3%d1%81%d1%82%d1%80%d0%b0%d0%bd%d0%b5%d0%bd%d0%b8%d0%b5%20%d0%bd%d0%b5%d0%bf%d0%be%d0%bb%d0%b0%d0%b4%d0%be%d0%ba%20%d0%bf%d1%80%d0%b8%20%d1%81%d0%b1%d1%80%d0%be%d1%81%d0%b5%20%d1%81%d0%be%d0%b5%d0%b4%d0%b8%d0%bd%d0%b5%d0%bd%d0%b8%d0%b9%20%d0%b2%20%d1%81%d1%80%d0%b5%d0%b4%d0%b0%d1%85%20%d1%87%d0%b0%d1%81%d1%82%d0%bd%d0%be%d0%b9%20%d1%81%d0%b5%d1%82%d0%b8%20%d1%88%d0%bb%d1%8e%d0%b7%d0%b0%20%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d0%b9%20Azure:%20%d0%ba%d1%80%d0%b8%d1%82%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b0%d1%8f%20%d1%80%d0%be%d0%bb%d1%8c%20%d0%bf%d0%b0%d1%80%d0%b0%d0%bc%d0%b5%d1%82%d1%80%d0%be%d0%b2%20SNI&amp;url=https://jiejue.ai/ru/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://jiejue.ai/ru/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://wa.me/?text=%d0%a3%d1%81%d1%82%d1%80%d0%b0%d0%bd%d0%b5%d0%bd%d0%b8%d0%b5%20%d0%bd%d0%b5%d0%bf%d0%be%d0%bb%d0%b0%d0%b4%d0%be%d0%ba%20%d0%bf%d1%80%d0%b8%20%d1%81%d0%b1%d1%80%d0%be%d1%81%d0%b5%20%d1%81%d0%be%d0%b5%d0%b4%d0%b8%d0%bd%d0%b5%d0%bd%d0%b8%d0%b9%20%d0%b2%20%d1%81%d1%80%d0%b5%d0%b4%d0%b0%d1%85%20%d1%87%d0%b0%d1%81%d1%82%d0%bd%d0%be%d0%b9%20%d1%81%d0%b5%d1%82%d0%b8%20%d1%88%d0%bb%d1%8e%d0%b7%d0%b0%20%d0%bf%d1%80%d0%b8%d0%bb%d0%be%d0%b6%d0%b5%d0%bd%d0%b8%d0%b9%20Azure:%20%d0%ba%d1%80%d0%b8%d1%82%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b0%d1%8f%20%d1%80%d0%be%d0%bb%d1%8c%20%d0%bf%d0%b0%d1%80%d0%b0%d0%bc%d0%b5%d1%82%d1%80%d0%be%d0%b2%20SNI%20https://jiejue.ai/ru/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/" target=_blank rel="noopener noreferrer" title="Share on WhatsApp"><ion-icon class=group-hover:text-primary-content name=logo-whatsapp></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img class="w-full z-30" src=https://jiejue.obs.ap-southeast-1.myhuaweicloud.com/20250318210156389.webp alt="Устранение неполадок при сбросе соединений в средах частной сети шлюза приложений Azure: критическая роль параметров SNI"><p>При переносе Azure Application Gateway из общедоступной сети в частную среду, даже если конфигурация кажется правильной, вы можете неожиданно столкнуться с проблемой сброса TLS-соединений. В этой статье мы расскажем о простой на первый взгляд, но часто упускаемой из виду ключевой настройке: параметре SNI (Server Name Indication) и о том, как с его помощью можно решить проблемы со сбросом соединений.</p><p>&lt;! &ndash;подробнее&ndash;></p><h2 id=сценарии-проблем>Сценарии проблем</h2><p>Недавно нам понадобилось перенести службу, развернутую на Azure Application Gateway, с публичного IP на частный IP, чтобы соответствовать требованиям безопасности. Процесс миграции кажется простым: измените <code>frontend_ip</code> с <code>appGwPublicIpv4</code> на <code>appGwPrivateIpv4</code> в конфигурации Terraform.</p><p>Однако после применения конфигурации при попытке доступа к сервису по-прежнему возникает следующая ошибка, даже если файл hosts правильно изменен для разрешения DNS:</p><pre tabindex=0><code>$ curl https://example.jiejue.ai/v1/chat/completions -v --resolve example.jiejue.ai:443:10.23.4.5
* Added example.jiejue.ai:443:10.23.4.5 to DNS cache
* Hostname example.jiejue.ai was found in DNS cache
*   Trying 10.23.4.5:443...
* Connected to example.jiejue.ai (10.23.4.5) port 443
* ALPN: curl offers h2,http/1.1
* (304) (OUT), TLS handshake, Client hello (1):
*  CAfile: /etc/ssl/cert.pem
*  CApath: none
* Recv failure: Connection reset by peer
* LibreSSL/3.3.6: error:02FFF036:system library:func(4095):Connection reset by peer
* Closing connection
curl: (35) Recv failure: Connection reset by peer
```.

При тестировании базового подключения с помощью telnet все в порядке:
</code></pre><p>$ telnet 10.23.4.5 443
Trying 10.23.4.5&mldr;
Connected to example.jiejue.ai.
Escape character is &lsquo;^]&rsquo;.
Connection closed by foreign host.</p><pre tabindex=0><code class=language-. data-lang=.>
Это означает, что базовое сетевое соединение работает, но что-то не так на этапе рукопожатия TLS.

## Решение: Включить SNI

После устранения неполадок мы обнаружили, что добавление простой строки конфигурации решило проблему:

```hcl
require_sni = true
```.

Этот параметр необходимо добавить в конфигурацию HTTPS-приемника. Полные различия в конфигурации Terraform выглядят следующим образом:

```diff
listener = {
  frontend_ip   = &#34;appGwPrivateIpv4&#34;
  frontend_port = 443
  protocol      = &#34;Https&#34;
+ require_sni   = true
}
</code></pre><p>После добавления этой строки служба немедленно возобновит нормальный доступ.</p><h2 id=почему-это-происходит-и-что-такое-sni>Почему это происходит и что такое SNI?</h2><p>SNI (Server Name Indication) - это расширение протокола TLS, которое позволяет клиенту указывать имя хоста, с которым он хочет соединиться, на ранней стадии процесса рукопожатия SSL/TLS. Это позволяет серверу предоставлять услуги HTTPS для нескольких различных доменов на одном IP-адресе, каждый из которых использует свой SSL-сертификат.</p><h3 id=как-работает-sni>Как работает SNI</h3><p>Процесс работы SNI выглядит следующим образом:</p><ol><li>клиент инициирует HTTPS-соединение и включает расширение SNI в сообщение ClientHello в процессе рукопожатия TLS, указывая имя целевого хоста.</li><li>сервер выбирает нужный SSL-сертификат на основе имени хоста.</li><li>сервер завершает рукопожатие TLS, используя выбранный сертификат.</li></ol><pre class=mermaid>
  flowchart TD
    subgraph &#34;客户端&#34;
        Client[用户浏览器]
    end

    subgraph &#34;Azure应用网关&#34;
        AppGW[应用网关]
        subgraph &#34;Listener配置&#34;
            PublicIP[公网IP监听器]
            PrivateIP[私网IP监听器]
        end
        subgraph &#34;TLS处理&#34;
            SNI[&#34;SNI处理&lt;br&gt;(Server Name Indication)&#34;]
            Cert1[&#34;证书1&lt;br&gt;example.jiejue.ai&#34;]
            Cert2[&#34;证书2&lt;br&gt;jiejue.ai&#34;]
        end
    end

    subgraph &#34;后端服务&#34;
        Backend1[后端服务1]
        Backend2[后端服务2]
    end

    Client --&gt;|1.HTTPS请求&lt;br&gt;包含SNI信息| AppGW
    AppGW --&gt; PublicIP
    AppGW --&gt; PrivateIP
    PublicIP --&gt;|2a. 公网IP&lt;br&gt;访问| SNI
    PrivateIP --&gt;|2b. 私网IP&lt;br&gt;访问| SNI
    SNI --&gt;|3a. 匹配主机名| Cert1
    SNI --&gt;|3b. 匹配主机名| Cert2
    Cert1 --&gt;|4a. 使用证书1| Backend1
    Cert2 --&gt;|4b. 使用证书2| Backend2
```_.

## Различия в поведении SNI между публичными и частными IP-адресами

Интересно, что мы обнаружили различия в том, как Application Gateway обрабатывает SNI в средах публичных и частных IP:

```mermaid
flowchart TD
    subgraph &#34;公网IP配置&lt;br&gt;require_sni = false&#34;
        C1[客户端] --&gt;|1.请求到公网IP| PG[应用网关&lt;br&gt;公网IP前端]
        PG --&gt;|2.TLS握手&lt;br&gt;没有SNI也能工作| PH[&#34;主机检查&lt;br&gt;(宽松)&#34;]
        PH --&gt;|3.选择默认证书| PB[后端服务]
    end

    subgraph &#34;私网IP配置&lt;br&gt;require_sni = false&#34;
        C2[客户端] --&gt;|1.请求到私网IP| VG[应用网关&lt;br&gt;私网IP前端]
        VG --&gt;|2.TLS握手&lt;br&gt;没有SNI信息| VH[&#34;主机检查&lt;br&gt;(严格)&#34;]
        VH --&gt;|3.无法确定证书&lt;br&gt;连接重置!| VB[后端服务]
    end

    subgraph &#34;私网IP配置&lt;br&gt;require_sni = true&#34;
        C3[客户端] --&gt;|1.请求到私网IP&lt;br&gt;包含主机名| SG[应用网关&lt;br&gt;私网IP前端]
        SG --&gt;|2.TLS握手&lt;br&gt;使用SNI信息| SH[&#34;主机检查&lt;br&gt;(严格)&#34;]
        SH --&gt;|3.正确匹配证书| SB[后端服务]
    end
```.

- **Общая IP-среда**: даже если клиент не предоставляет информацию SNI (например, прямой доступ по IP), Application Gateway может выбрать сертификат &#34;по умолчанию&#34; для завершения рукопожатия TLS.
- **Частная IP-среда**: если клиент не предоставит информацию SNI, шлюз приложений напрямую сбросит соединение, что приведет к сбою в рукопожатии TLS.

Это различие может быть связано с внутренней реализацией Azure или политикой безопасности, но такое поведение не указано в официальной документации Microsoft.

## Дополнительные сведения о параметрах SNI

В конфигурации Terraform для Azure Application Gateway параметр `require_sni` определен следующим образом:
</pre><p>require_sni - (Optional) Should Server Name Indication be Required? Defaults to false.</p><pre tabindex=0><code>
Хотя официально этот параметр описывается как необязательный и по умолчанию принимает значение `false`, на самом деле он необходим в частных сетевых средах, особенно в следующих случаях:

1. несколько сайтов используют один и тот же шлюз приложений
2. используется протокол HTTPS
3. внешний IP-адрес настроен как частный IP-адрес

## Предложения по устранению неполадок

Если вы столкнулись с подобными проблемами сброса соединения в среде частной сети Azure Application Gateway, попробуйте выполнить следующие шаги по устранению неполадок:

1. проверьте базовое соединение (с помощью такого инструмента, как telnet).
2. убедитесь, что сертификаты настроены правильно
3. **Проверьте настройки SNI**, чтобы убедиться, что для HTTPS-приемника установлено значение `require_sni = true`.
4. убедитесь, что запрос клиента содержит правильное имя хоста (а не просто IP)

## Почему Azure Portal справляется с этим автоматически?

Интересно, что если вы вручную переключите внешний IP-адрес шлюза приложений с публичного на частный в Azure Portal, Portal автоматически включит требование SNI. Это говорит о том, что Microsoft знает об этой поведенческой разнице и разумно обрабатывает ее в операциях пользовательского интерфейса.

Однако при использовании инструмента IaC, такого как Terraform, такой автоматической настройки не происходит, и конфигурацию `require_sni = true` необходимо добавлять вручную.

## Рекомендации по лучшей практике

Основываясь на нашем опыте, мы рекомендуем следующие лучшие практики:

1. **Всегда включайте SNI**: установите `require_sni = true` как для публичных, так и для частных сетевых сред.
2. **Используйте доступ по доменному имени**: убедитесь, что клиенты получают доступ к сервису напрямую через доменное имя, а не через IP
3. **Конфигурировать явно в IaC**: задавать параметры SNI явно в коде, например в Terraform
4. **Документированные требования к конфигурации**: укажите эту критическую конфигурацию в проектной документации.

## Более глубокое понимание: архитектура SNI для шлюза приложений

Для читателей, желающих погрузиться в технические подробности, приведем архитектурную схему обработки SNI в Azure Application Gateway:










  <svg viewBox="0 0 900 500"><rect width="900" height="500" fill="#f9f9f9"/><rect x="100" y="50" width="700" height="400" rx="20" ry="20" fill="#f0f7ff" stroke="#0078d4" stroke-width="2" stroke-dasharray="5,5"/><text x="400" y="80" font-family="Arial" font-size="16" text-anchor="middle" fill="#0078d4">Azure Cloud Environment</text><rect x="20" y="200" width="100" height="80" rx="10" ry="10" fill="#fff" stroke="#666" stroke-width="2"/><text x="70" y="245" font-family="Arial" font-size="14" text-anchor="middle">客户端</text><rect x="200" y="150" width="500" height="200" rx="15" ry="15" fill="#e1ebf7" stroke="#0078d4" stroke-width="2"/><text x="450" y="175" font-family="Arial" font-size="16" text-anchor="middle" font-weight="bold" fill="#0078d4">应用网关 (Application Gateway)</text><rect x="220" y="190" width="120" height="140" rx="5" ry="5" fill="#fff" stroke="#666" stroke-width="1"/><text x="280" y="210" font-family="Arial" font-size="12" text-anchor="middle">前端IP配置</text><rect x="230" y="220" width="100" height="40" rx="5" ry="5" fill="#d4edda" stroke="#28a745" stroke-width="1"/><text x="280" y="245" font-family="Arial" font-size="12" text-anchor="middle">公网IP</text><rect x="230" y="270" width="100" height="40" rx="5" ry="5" fill="#f8d7da" stroke="#dc3545" stroke-width="1"/><text x="280" y="295" font-family="Arial" font-size="12" text-anchor="middle">私网IP</text><rect x="360" y="190" width="120" height="140" rx="5" ry="5" fill="#fff3cd" stroke="#ffc107" stroke-width="1"/><text x="420" y="210" font-family="Arial" font-size="12" text-anchor="middle" font-weight="bold">SNI处理层</text><text x="420" y="230" font-family="Arial" font-size="10" text-anchor="middle">Server Name Indication</text><rect x="370" y="240" width="100" height="30" rx="5" ry="5" fill="#fff" stroke="#666" stroke-width="1"/><text x="420" y="260" font-family="Arial" font-size="10" text-anchor="middle">require_sni=false</text><rect x="370" y="280" width="100" height="30" rx="5" ry="5" fill="#fff" stroke="#666" stroke-width="1"/><text x="420" y="300" font-family="Arial" font-size="10" text-anchor="middle">require_sni=true</text><rect x="500" y="190" width="180" height="140" rx="5" ry="5" fill="#e2e3e5" stroke="#6c757d" stroke-width="1"/><text x="590" y="210" font-family="Arial" font-size="12" text-anchor="middle">SSL证书存储</text><rect x="510" y="220" width="160" height="30" rx="5" ry="5" fill="#fff" stroke="#6c757d" stroke-width="1"/><text x="590" y="240" font-family="Arial" font-size="10" text-anchor="middle">example.jiejue.ai</text><rect x="510" y="260" width="160" height="30" rx="5" ry="5" fill="#fff" stroke="#6c757d" stroke-width="1"/><text x="590" y="280" font-family="Arial" font-size="10" text-anchor="middle">jiejue.ai</text><rect x="510" y="300" width="160" height="30" rx="5" ry="5" fill="#fff" stroke="#6c757d" stroke-width="1"/><text x="590" y="320" font-family="Arial" font-size="10" text-anchor="middle">其他域名证书...</text><rect x="750" y="150" width="120" height="80" rx="10" ry="10" fill="#fff" stroke="#6c757d" stroke-width="2"/><text x="810" y="195" font-family="Arial" font-size="14" text-anchor="middle">后端服务 1</text><rect x="750" y="250" width="120" height="80" rx="10" ry="10" fill="#fff" stroke="#6c757d" stroke-width="2"/><text x="810" y="295" font-family="Arial" font-size="14" text-anchor="middle">后端服务 2</text><line x1="120" y1="240" x2="200" y2="240" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/><text x="160" y="230" font-family="Arial" font-size="10" text-anchor="middle">HTTPS请求</text><line x1="340" y1="240" x2="360" y2="240" stroke="#28a745" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="340" y1="290" x2="360" y2="290" stroke="#dc3545" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="480" y1="240" x2="500" y2="240" stroke="#ffc107" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="480" y1="290" x2="500" y2="290" stroke="#ffc107" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="680" y1="235" x2="750" y2="190" stroke="#6c757d" stroke-width="2" marker-end="url(#arrowhead)"/><line x1="680" y1="275" x2="750" y2="290" stroke="#6c757d" stroke-width="2" marker-end="url(#arrowhead)"/><defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#666"/></marker></defs><rect x="150" y="380" width="600" height="50" rx="5" ry="5" fill="#d1ecf1" stroke="#17a2b8" stroke-width="1"/><text x="450" y="410" font-family="Arial" font-size="12" text-anchor="middle" fill="#0c5460"><tspan x="450" dy="0">关键点: 私网IP环境中，require_sni=true 强制客户端提供主机名，</tspan><tspan x="450" dy="20">使应用网关能够正确选择SSL证书，避免连接重置问题</tspan></text></svg>


.

Конфигурация SNI влияет на весь процесс рукопожатия TLS, особенно в многосайтовых средах. При использовании `require_sni = true` шлюз приложений строго требует от клиента информацию об имени хоста, что не только повышает безопасность, но и обеспечивает правильный выбор сертификата и маршрутизацию запросов.

## Заключение

Параметр SNI играет ключевую роль в конфигурации частной сети Azure Application Gateway, причем не только как дополнительное улучшение безопасности, но и как необходимая конфигурация для обеспечения правильной работы службы. Понимание этой тонкой разницы между публичной и частной сетевыми средами поможет вам избежать лишнего времени на устранение неполадок и разработать более надежную облачную архитектуру.

Наконец, этот случай служит напоминанием о том, что даже самые простые параметры конфигурации могут оказывать значительное влияние на доступность службы, и что необходимо уделять особое внимание этим &#34;стандартным&#34;, но критически важным элементам конфигурации, особенно во время миграции или изменения среды.

Сталкивались ли вы с подобными проблемами конфигурации облачных сервисов? Не стесняйтесь поделиться своим опытом в разделе комментариев!
</code></pre></section><div class=divider></div><div class="flex flex-col md:flex-row justify-between gap-4 py-4"><a role=button class="btn btn-outline h-12" href=/ru/2025/03/embedding-svg-in-hugo-blog-easy-way/ title="Элегантное встраивание SVG-изображений в блоги Hugo: простой и практичный подход"><ion-icon name=chevron-back></ion-icon><div class="inline-flex flex-col items-start"><span class="text-base-content/60 text-xs font-normal">Предыдущая</span>
<span class="max-w-48 truncate">Элегантное встраивание SVG-изображений в блоги Hugo: простой и практичный подход</span></div></a><a role=button class="btn btn-outline h-12" href=/ru/2025/03/mcp-beginner-guide-finding-services/ title="Начало работы с MCP: попрощайтесь с тонкой настройкой и легко находите службы с открытым исходным кодом"><div class="inline-flex flex-col items-end"><span class="text-base-content/60 text-xs font-normal">Следующая</span>
<span class="max-w-48 truncate">Начало работы с MCP: попрощайтесь с тонкой настройкой и легко находите службы с открытым исходным кодом</span></div><ion-icon name=chevron-forward></ion-icon></a></div><div class=divider></div><section class=space-y-4><article><div id=tcomment></div><script src=https://cdn.jsdelivr.net/npm/twikoo@1.6.41/dist/twikoo.min.js></script><script>twikoo.init({envId:"https://6dhzwvtyqz753zhpkrvnnydhlm0vubmy.lambda-url.ap-east-1.on.aws/",el:"#tcomment",region:"ap-east-1",path:"/ru/2025/03/solving-connection-reset-with-sni-in-azure-application-gateway/",lang:"zh-CN"})</script></article></section></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#сценарии-проблем>Сценарии проблем</a></li><li><a href=#почему-это-происходит-и-что-такое-sni>Почему это происходит и что такое SNI?</a><ul><li><a href=#как-работает-sni>Как работает SNI</a></li></ul></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 ЛюбимРешать</p><p>一个热爱解决问题的网站</p></div><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
本站总访问量 <span id=busuanzi_value_site_pv></span>
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user"></i>
本站访客数 <span id=busuanzi_value_site_uv></span></span></section></span></section></script><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 ЛюбимРешать</p><p>一个热爱解决问题的网站</p></div><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
本站总访问量 <span id=busuanzi_value_site_pv></span>
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user"></i>
本站访客数 <span id=busuanzi_value_site_uv></span></span></section></span></section></script><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"ru"}).toFormat("yyyy年MM月dd日 HH:mm")})}</script><script src=/js/toc.min.js></script><script type=module>
      import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
      mediumZoom('#dream-single-post-content img', {
        background: 'oklch(var(--b1))',
        margin: 24,
      })
    </script><script type=module>
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
      </script><script async src="https://www.googletagmanager.com/gtag/js?id=G-S0KCH9BW4F"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-S0KCH9BW4F")}</script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>